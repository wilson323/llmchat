# ========================================
# Logstash 管道配置
# 处理 LLMChat 后端日志
# ========================================

input {
  # 从 Filebeat 接收日志
  beats {
    port => 5044
  }
  
  # 从 HTTP 接收日志（应用直接推送）
  http {
    port => 8080
    codec => json
  }
}

filter {
  # 解析 JSON 日志
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
    }
    
    # 提取字段到顶层
    if [parsed] {
      mutate {
        add_field => {
          "log_level" => "%{[parsed][level]}"
          "log_message" => "%{[parsed][message]}"
          "log_timestamp" => "%{[parsed][timestamp]}"
          "service_name" => "llmchat-backend"
        }
      }
      
      # 提取请求信息
      if [parsed][requestId] {
        mutate {
          add_field => { "request_id" => "%{[parsed][requestId]}" }
        }
      }
      
      # 提取用户信息
      if [parsed][userId] {
        mutate {
          add_field => { "user_id" => "%{[parsed][userId]}" }
        }
      }
      
      # 提取错误信息
      if [parsed][error] {
        mutate {
          add_field => { "error_message" => "%{[parsed][error][message]}" }
          add_field => { "error_stack" => "%{[parsed][error][stack]}" }
        }
      }
    }
  }
  
  # 地理位置解析（如果有IP）
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # 添加时间戳
  date {
    match => [ "log_timestamp", "ISO8601" ]
    target => "@timestamp"
  }
  
  # 清理不需要的字段
  mutate {
    remove_field => [ "parsed", "message" ]
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "llmchat-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # 调试输出（开发环境）
  # stdout {
  #   codec => rubydebug
  # }
}
