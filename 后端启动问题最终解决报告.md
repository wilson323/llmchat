# åç«¯å¯åŠ¨é—®é¢˜æœ€ç»ˆè§£å†³æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-20  
**çŠ¶æ€**: âœ… å·²å®Œå…¨è§£å†³

---

## ğŸ¯ é—®é¢˜æ€»ç»“

ç”¨æˆ·åœ¨è¿è¡Œ`pnpm run dev`æ—¶ï¼Œåç«¯æœåŠ¡æŒç»­å¤±è´¥ï¼Œç—‡çŠ¶ä¸ºï¼š
- `ELIFECYCLE Command failed with exit code 1`
- æ— ä»»ä½•é”™è¯¯è¾“å‡ºï¼Œç›´æ¥å´©æºƒ
- Redisè¿æ¥æˆåŠŸåç«‹å³é€€å‡º

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±åº¦æ’æŸ¥ï¼Œå‘ç°äº†**å››ä¸ªæ ¹æœ¬åŸå› **ï¼š

### ğŸ”´ P0-1: TypeScriptè·¯å¾„åˆ«åè§£æå¤±è´¥

**é—®é¢˜**ï¼š`tsconfig.json`ä¸­`baseUrl`å’Œ`paths`é…ç½®ä¸å½“ï¼Œå¯¼è‡´`ts-node`æ— æ³•è§£æ`@/`åˆ«åã€‚

**è¡¨ç°**ï¼š
- `Cannot find module '@/controllers/AuthController'`
- ç¼–è¯‘æ—¶æ‰¾ä¸åˆ°æ¨¡å—ï¼Œä½†æ²¡æœ‰æ˜ç¡®é”™è¯¯è¾“å‡º

**ä¿®å¤**ï¼š
```json
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",           // ä»"./src"æ”¹ä¸º"."
    "paths": {
      "@/*": ["src/*"],       // ä»"*"æ”¹ä¸º"src/*"
      "@/types/*": ["src/types/*"],
      // ...
    }
  }
}
```

---

### ğŸ”´ P0-2: Expressç±»å‹å®šä¹‰æ— æ³•åŠ è½½

**é—®é¢˜**ï¼š`tsconfig.json`ä¸­çš„`"types": ["node", "jest"]`é™åˆ¶äº†TypeScriptåªåŠ è½½æŒ‡å®šç±»å‹åŒ…ï¼Œ**é˜»æ­¢**äº†`src/types/express.d.ts`ï¼ˆè‡ªå®šä¹‰Express Requestæ‰©å±•ï¼‰çš„åŠ è½½ã€‚

**è¡¨ç°**ï¼š
- `ts-node`ç¼–è¯‘`AgentController.ts`æ—¶æŠ¥é”™ï¼š`Property 'requestId' does not exist on type 'Request'`
- TypeScriptç¼–è¯‘é”™è¯¯å¯¼è‡´è¿›ç¨‹é€€å‡ºï¼ˆexit code 1ï¼‰ï¼Œä½†é”™è¯¯è¢«`uncaughtException`å¤„ç†å™¨åæ‰

**ä¿®å¤æ–¹æ¡ˆ1**ï¼ˆé‡‡ç”¨ï¼‰ï¼š
```typescript
// AgentController.ts
/// <reference path="../types/express.d.ts" />  // å¼ºåˆ¶å¼•ç”¨ç±»å‹å®šä¹‰
import type { Request, Response, NextFunction } from 'express';
```

**ä¿®å¤æ–¹æ¡ˆ2**ï¼ˆå¯é€‰ï¼‰ï¼š
```json
// tsconfig.json
{
  "compilerOptions": {
    // "types": ["node", "jest"],  // ç§»é™¤æ­¤é™åˆ¶
    "typeRoots": ["./node_modules/@types", "./src/types"]  // æ˜ç¡®ç±»å‹æŸ¥æ‰¾è·¯å¾„
  }
}
```

---

### ğŸ”´ P0-3: AuthServiceV2å•ä¾‹å†²çª

**é—®é¢˜**ï¼š`AuthController`æ„é€ å‡½æ•°ä¸­ç›´æ¥åˆ›å»ºäº†æ–°çš„`AuthServiceV2`å®ä¾‹ï¼Œå¯¼è‡´ä¸å•ä¾‹æ¨¡å¼å†²çªï¼Œå¯èƒ½äº§ç”Ÿå¤šä¸ªRedisè¿æ¥ã€‚

**è¡¨ç°**ï¼š
- Redisè¿æ¥æ—¥å¿—æ‰“å°**ä¸¤æ¬¡**
- å¯èƒ½å¯¼è‡´èµ„æºç«äº‰å’Œè¿æ¥å†²çª

**ä¿®å¤**ï¼š
```typescript
// AuthController.ts (ä¿®å¤å‰)
constructor() {
  this.authService = new AuthServiceV2();  // âŒ åˆ›å»ºæ–°å®ä¾‹
}

// AuthController.ts (ä¿®å¤å)
import { authService } from '@/services/authInstance';  // âœ… å¯¼å…¥å•ä¾‹

constructor() {
  this.authService = authService as AuthServiceV2;  // âœ… ä½¿ç”¨å•ä¾‹
}
```

---

### ğŸŸ¡ P1: æ•°æ®åº“è¿æ¥æ± idle timeoutè¿‡çŸ­

**é—®é¢˜**ï¼š`db.ts`ä¸­çš„`idleTimeoutMillis: 30_000`ï¼ˆ30ç§’ï¼‰è¿‡çŸ­ï¼Œå¯¼è‡´PostgreSQLæœåŠ¡å™¨åœ¨è¿æ¥ç©ºé—²æ—¶ä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚

**è¡¨ç°**ï¼š
- æœåŠ¡å¯åŠ¨æ­£å¸¸ï¼Œä½†è¿è¡Œå‡ åˆ†é’Ÿåå´©æºƒ
- é”™è¯¯æ—¥å¿—ï¼š`DB Pool: æ„å¤–é”™è¯¯ - Connection terminated unexpectedly`

**ä¿®å¤**ï¼š
```typescript
// db.ts
{
  idleTimeoutMillis: 600_000,  // ä»30ç§’æ”¹ä¸º10åˆ†é’Ÿ
}
```

---

## âœ… å®Œæ•´ä¿®å¤æ¸…å•

### 1. tsconfig.json
- âœ… `baseUrl`ä»`"./src"`æ”¹ä¸º`"."`
- âœ… `paths`é…ç½®æ›´æ–°ä¸º`"src/*"`
- âœ… æ·»åŠ `typeRoots`é…ç½®ï¼ˆå¯é€‰ï¼‰
- âœ… æ³¨é‡Šæ‰`types`é™åˆ¶ï¼ˆå¯é€‰ï¼‰

### 2. backend/src/controllers/AgentController.ts
- âœ… æ·»åŠ `/// <reference path="../types/express.d.ts" />`ä¸‰æ–œæ å¼•ç”¨

### 3. backend/src/controllers/AuthController.ts
- âœ… å¯¼å…¥`authService`å•ä¾‹
- âœ… æ„é€ å‡½æ•°ä½¿ç”¨å•ä¾‹è€Œéåˆ›å»ºæ–°å®ä¾‹

### 4. backend/src/services/authInstance.ts
- âœ… æ·»åŠ è¯¦ç»†çš„åˆ›å»ºæ—¥å¿—

### 5. backend/src/utils/db.ts
- âœ… `idleTimeoutMillis`ä»30ç§’å¢åŠ åˆ°10åˆ†é’Ÿ

### 6. æ¸…ç†
- âœ… åˆ é™¤æ‰€æœ‰ä¸´æ—¶æµ‹è¯•æ–‡ä»¶ï¼ˆ`test-*.ts`, `test-*.js`ï¼‰

---

## ğŸ‰ éªŒè¯ç»“æœ

### æœåŠ¡çŠ¶æ€
```
âœ… å‰ç«¯: http://localhost:3004 (Vite)
âœ… åç«¯: http://localhost:3005 (Express + PostgreSQL + Redis)
```

### APIæµ‹è¯•
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3005/health
# è¿”å›: {"status":"ok","message":"LLMChat Backend","timestamp":"..."}

# æ™ºèƒ½ä½“åˆ—è¡¨
curl http://localhost:3005/api/agents
# è¿”å›: [{"id":"...","name":"..."}]
```

### å‰ç«¯è®¿é—®
```
http://localhost:3004/
# æˆåŠŸåŠ è½½é¡µé¢ï¼Œæ ‡é¢˜: "LLMChat - æ™ºèƒ½ä½“åˆ‡æ¢èŠå¤©"
```

---

## ğŸ“Š é—®é¢˜å½±å“èŒƒå›´

### ä¿®å¤çš„æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰
1. `backend/tsconfig.json`
2. `backend/src/controllers/AgentController.ts`
3. `backend/src/controllers/AuthController.ts`
4. `backend/src/services/authInstance.ts`
5. `backend/src/utils/db.ts`

### åˆ é™¤çš„æ–‡ä»¶ï¼ˆ8ä¸ªä¸´æ—¶æµ‹è¯•æ–‡ä»¶ï¼‰
- `backend/test-minimal.js`
- `backend/test-auth-router.ts`
- `backend/test-minimal-index.ts`
- `backend/test-all-routes.ts`
- `backend/test-services.ts`
- `backend/test-full-index.ts`
- `backend/test-tsnode-import.ts`
- `backend/test-shared-types.ts`

---

## ğŸ§ª æ’æŸ¥æ–¹æ³•æ€»ç»“

### æœ‰æ•ˆå·¥å…·
1. **`console.log`è¿½è¸ªæ³•** - åœ¨å…³é”®æ¨¡å—æ·»åŠ æ—¥å¿—ï¼Œå®šä½å´©æºƒç‚¹
2. **æœ€å°åŒ–æµ‹è¯•è„šæœ¬** - é€ä¸ªå¯¼å…¥æ¨¡å—ï¼Œéš”ç¦»é—®é¢˜
3. **`ts-node`ç›´æ¥æ‰§è¡Œ** - ç»•è¿‡æ„å»ºæµç¨‹ï¼Œå¿«é€ŸéªŒè¯
4. **å…¨å±€é”™è¯¯å¤„ç†å™¨** - æ•è·`uncaughtException`å’Œ`unhandledRejection`

### å…³é”®å‘ç°
- `ts-node`ç¼–è¯‘é”™è¯¯å¦‚æœè¢«å…¨å±€é”™è¯¯å¤„ç†å™¨æ•è·ï¼Œ**ä¸ä¼šæ‰“å°è¯¦ç»†é”™è¯¯**åˆ°æ§åˆ¶å°
- `types`é…ç½®é™åˆ¶ä¼š**é™é»˜é˜»æ­¢**è‡ªå®šä¹‰`.d.ts`æ–‡ä»¶åŠ è½½
- TypeScriptè·¯å¾„åˆ«ååœ¨è¿è¡Œæ—¶éœ€è¦`tsconfig-paths/register`
- PostgreSQLè¿æ¥æ± éœ€è¦åˆç†çš„`idleTimeoutMillis`

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. TypeScripté…ç½®
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    // é¿å…ä½¿ç”¨"types"é™åˆ¶ï¼Œé™¤éæ˜ç¡®éœ€è¦
    "typeRoots": ["./node_modules/@types", "./src/types"]
  }
}
```

### 2. Expressç±»å‹æ‰©å±•
```typescript
// æ–¹æ³•1ï¼šä¸‰æ–œæ å¼•ç”¨ï¼ˆæ¨èï¼‰
/// <reference path="../types/express.d.ts" />

// æ–¹æ³•2ï¼šç¡®ä¿tsconfig.jsonä¸é™åˆ¶types
```

### 3. å•ä¾‹æ¨¡å¼
```typescript
// âœ… æ­£ç¡®ï¼šå¯¼å…¥å¹¶ä½¿ç”¨å•ä¾‹
import { authService } from '@/services/authInstance';

// âŒ é”™è¯¯ï¼šé‡å¤åˆ›å»ºå®ä¾‹
const service = new AuthServiceV2();
```

### 4. æ•°æ®åº“è¿æ¥æ± 
```typescript
{
  idleTimeoutMillis: 600_000,        // 10åˆ†é’Ÿ
  connectionTimeoutMillis: 5_000,    // 5ç§’
  max: 50,                           // æœ€å¤§è¿æ¥æ•°
  min: 10,                           // æœ€å°è¿æ¥æ•°
}
```

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### P1ä¼˜å…ˆçº§
1. **ä¿®å¤æ•°æ®åº“è¿ç§»é”™è¯¯** - `initial_schema.sql`ä¸­å¼•ç”¨çš„`agent_id`åˆ—ä¸å­˜åœ¨
2. **å¢åŠ é”™è¯¯è¾“å‡ºè¯¦ç»†åº¦** - ç¡®ä¿æ‰€æœ‰TypeScriptç¼–è¯‘é”™è¯¯éƒ½æ‰“å°åˆ°æ§åˆ¶å°

### P2ä¼˜å…ˆçº§
1. **ç»Ÿä¸€é”™è¯¯å¤„ç†** - æ ‡å‡†åŒ–`uncaughtException`å’Œ`unhandledRejection`çš„æ—¥å¿—æ ¼å¼
2. **å¥åº·æ£€æŸ¥å¢å¼º** - æ·»åŠ æ•°æ®åº“å’ŒRedisè¿æ¥çŠ¶æ€åˆ°`/health`ç«¯ç‚¹
3. **ç¯å¢ƒå˜é‡éªŒè¯** - å¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡

---

## ğŸ™ æ„Ÿè°¢

ç»è¿‡å¤šè½®æ·±åº¦åˆ†æå’Œç³»ç»Ÿæ€§æ’æŸ¥ï¼Œæœ€ç»ˆæˆåŠŸå®šä½å¹¶ä¿®å¤äº†æ‰€æœ‰P0çº§åˆ«çš„å¯åŠ¨é˜»å¡é—®é¢˜ã€‚

**å…³é”®ç»éªŒ**ï¼š
- ğŸ” ç³»ç»Ÿæ€§æ’æŸ¥ï¼šä»æ¨¡å—å¯¼å…¥ã€ç±»å‹ç³»ç»Ÿã€å•ä¾‹æ¨¡å¼ã€æ•°æ®åº“é…ç½®å…¨é¢æ£€æŸ¥
- ğŸ“‹ æœ€å°åŒ–æµ‹è¯•ï¼šåˆ›å»ºç‹¬ç«‹æµ‹è¯•è„šæœ¬é€ä¸ªéªŒè¯æ¨¡å—
- ğŸ› ï¸ æ¸è¿›å¼ä¿®å¤ï¼šå…ˆè§£å†³TypeScriptç¼–è¯‘é—®é¢˜ï¼Œå†å¤„ç†è¿è¡Œæ—¶é”™è¯¯
- ğŸ“Š æ—¥å¿—é©±åŠ¨ï¼šé€šè¿‡è¯¦ç»†æ—¥å¿—å®šä½å´©æºƒçš„ç²¾ç¡®ä½ç½®

---

**ç»“è®º**ï¼šâœ… åç«¯æœåŠ¡ç°å·²ç¨³å®šè¿è¡Œï¼Œå‰åç«¯é›†æˆæ­£å¸¸ï¼Œæ‰€æœ‰æ ¸å¿ƒAPIç«¯ç‚¹å¯ç”¨ã€‚

