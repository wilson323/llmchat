# 🏢 企业级代码修复规则手册

## 📋 项目特定规则配置

### 🔒 本项目严格禁止的危险模式
```typescript
// ❌ 严格禁止：正则表达式代码替换
const content = fileContent.replace(/import\s+.*from\s+['\"](.*)['\"]/, 'import * from $1');
const config = JSON.parse(jsonStr.replace(/\bpassword['\"]?\s*:\s*['\"](.*)['\"]/, 'password: \"***\"'));

// ❌ 严格禁止：动态构造正则表达式
const regex = new RegExp(userInput, 'g');
const result = text.replace(regex, replacement);

// ❌ 严格禁止：命令行文本修改
execSync(`sed -i 's/old/new/g' ${file}`);

// ❌ 严格禁止：企业级自动修复不经过确认
if (isHighRisk) {
  const fixed = autoFix(code); // 禁止
}
```

### ✅ 本项目推荐的安全模式
```typescript
// ✅ 推荐：AST解析和操作
import * as ts from 'typescript';
const sourceFile = ts.createSourceFile(fileName, content, ts.ScriptTarget.Latest);
const ast = ts.factory.createStringLiteral("safe replacement");

// ✅ 推荐：专门的JSON处理
const config = JSON.parse(jsonContent);
config.sensitiveField = "***";

// ✅ 推荐：类型安全处理
interface SafeConfig {
  readonly apiUrl: string;
  readonly maxRetries: number;
}

// ✅ 推荐：企业级修复工具
pnpm run enterprise:fix  // dry-run模式预览
pnpm run enterprise:fix --mode fix  // 交互式修复
```

## 🎯 本项目企业级修复规则

### 1. React Hook安全规则 (error级别)
```typescript
// ❌ 危险：Hook在条件语句中使用
if (condition) {
  const [state, setState] = useState(null); // 危险
  useEffect(() => {}, [state]); // 可能的内存泄漏
}

// ✅ 安全：Hook在组件顶层使用
const MyComponent = () => {
  const [state, setState] = useState(null);
  const [data, setData] = useState(null);

  useEffect(() => {
    // 安全的Hook使用
  }, [data]); // 依赖数组正确
}
```

### 2. Ref.current 安全规则 (error级别)
```typescript
// ❌ 危险：ref.current在依赖数组中
useEffect(() => {
  fetchData(ref.current.value);
}, [ref.current]); // 危险：可能导致无限循环

// ✅ 安全：稳定的引用
useEffect(() => {
  fetchData(ref.current.value);
}, []); // 依赖数组为空或稳定值

// ✅ 安全：回调函数中的ref使用
useEffect(() => {
  const updateRef = () => {
    fetchData(ref.current.value);
  };
  updateRef();
}, [updateRef]); // 稳定的函数引用
```

### 3. 类型安全规则 (warning级别)
```typescript
// ❌ 避免：隐式any类型
const data: any = fetchData(); // 避免
const config = {} as any; // 避免

// ✅ 推荐：明确的类型定义
interface ApiResponse {
  success: boolean;
  data: unknown;
  error?: string;
}

const data: ApiResponse = await fetchData();
const config: Record<string, unknown> = {};
```

### 4. 对象字面量规则 (warning级别)
```typescript
// ❌ 避免：无类型注解的对象字面量
const config = {
  apiUrl: 'https://api.example.com',
  timeout: 5000
};

// ✅ 推荐：明确的类型定义
interface AppConfig {
  apiUrl: string;
  timeout: number;
  retries?: number;
}

const config: AppConfig = {
  apiUrl: 'https://api.example.com',
  timeout: 5000
};
```

### 5. 模块系统规则 (warning级别)
```typescript
// ❌ 避免：CommonJS require（如果项目使用ES模块）
const lib = require('./library'); // 避免

// ✅ 推荐：ES模块导入
import lib from './library';
import { helper } from './utils';

// ✅ 推荐：动态导入（按需加载）
const lib = await import('./library');
```

### 6. 配置安全规则 (warning级别)
```typescript
// ❌ 避免：硬编码的敏感值
const API_KEY = "sk-1234567890abcdef";
const DB_PASSWORD = "password123";

// ✅ 推荐：环境变量
const API_KEY = process.env.API_KEY;
const DB_PASSWORD = process.env.DB_PASSWORD;

// ✅ 推荐：配置验证
const config = {
  apiKey: process.env.API_KEY || throw new Error('API_KEY is required'),
  dbPassword: process.env.DB_PASSWORD || throw new Error('DB_PASSWORD is required')
};
```

## 📊 修复影响分析标准

### 语义变化级别
- **none**: 修复不改变代码语义（推荐）
- **minor**: 轻微的语义变化，需要测试验证
- **major**: 重大语义变化，需要全面测试

### 性能影响级别
- **none**: 无性能影响
- **low**: 轻微性能提升或降低
- **medium**: 明显性能变化
- **high**: 重大性能影响

### 可读性变化级别
- **none**: 可读性无变化
- **positive**: 提高代码可读性（推荐）
- **negative**: 降低代码可读性

### 破坏风险级别
- **none**: 无破坏风险（推荐）
- **low**: 低破坏风险，影响范围小
- **medium**: 中等破坏风险，需要测试验证
- **high**: 高破坏风险，需要全面评估

## 🛡️ 企业级安全检查清单

### 修复前检查
- [ ] 文件大小 < 1MB
- [ ] 内存使用 < 500MB
- [ ] 语法检查通过
- [ ] 类型检查通过
- [ ] 依赖分析完成
- [ ] 备份文件已创建

### 修复过程检查
- [ ] AST节点精确定位
- [ ] 修复影响分析完成
- [ ] 人工确认（高风险问题）
- [ ] 原子操作执行
- [ ] 修复验证通过

### 修复后检查
- [ ] 语法检查通过
- [ ] 类型检查通过
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 代码审查完成
- [ ] 部署前验证完成

## 🔧 本项目使用指南

### 日常开发
```bash
# 每日开发前检查
pnpm run security:check

# 提交前检查
pnpm run lint && pnpm run type-check && pnpm run security:check

# 代码质量检查
pnpm run quality-check
```

### 代码修复流程
```bash
# 1. 分析问题（dry-run模式）
pnpm run enterprise:fix

# 2. 审查修复预览和影响分析
# 查看控制台输出的详细报告

# 3. 交互式修复（需要确认）
pnpm run enterprise:fix --mode fix

# 4. 验证修复结果
pnpm run type-check && pnpm run test
```

### 团队协作
```bash
# 团队代码审查
pnpm run enterprise:fix --mode fix
# 生成详细报告供团队审查

# CI/CD集成
pnpm run enterprise:fix --config .github/workflows/enterprise-fix.yml
```

## 📈 配置管理

### 环境特定配置
```bash
# 开发环境配置
cp .enterprise-code-fixer.config.dev.json .enterprise-code-fixer.config.json

# 测试环境配置
cp .enterprise-code-fixer.config.test.json .enterprise-code-fixer.config.json

# 生产环境配置
cp .enterprise-code-fixer.config.prod.json .enterprise-code-fixer.config.json
```

### 团队配置同步
```bash
# 更新团队配置
pnpm run enterprise:fix --sync-config

# 验证配置一致性
pnpm run enterprise:fix --validate-config
```

## 🚨 紧急情况处理

### 高风险修复回滚
```bash
# 紧急回滚所有修复
pnpm run enterprise:fix --rollback

# 回滚特定文件
pnpm run enterprise:fix --rollback --file src/components/MyComponent.tsx
```

### 安全紧急停止
```bash
# 立即停止所有修复操作
pnpm run enterprise:fix --emergency-stop
```

## 📚 企业级最佳实践

### 1. 渐进式修复
- 小批量修复，每次处理5-10个文件
- 修复后立即测试验证
- 建立修复历史记录

### 2. 团队协作
- 重要修复需要团队审查
- 建立修复标准和流程
- 定期安全培训

### 3. 持续改进
- 收集团队反馈
- 优化修复规则
- 更新安全配置

### 4. 监控和报告
- 建立修复指标监控
- 定期生成安全报告
- 跟踪修复效果

## 🔗 相关资源

- [TypeScript AST API文档](https://github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API)
- [企业级配置示例](./.enterprise-code-fixer.config.json)
- [安全配置模式](./.enterprise-fixer-schema.json)
- [企业级修复工具](./backend/src/scripts/enterprise-code-fixer.ts)

---

**记住**: 安全修复工具是辅助工具，不能替代人工判断。企业级安全要求工具和人工相结合，确保代码质量和项目安全。