# 管理页面需求（登录态与访问控制）

> 本文档定义 /login 与 /home 路由的登录流程、前端登录态持久化方案、未登录访问拦截策略、后端接口约定、UI与交互细节、验收标准与测试建议。前后端均以本项目技术栈（React 18 + Vite + Tailwind + Zustand；Node.js + Express + TypeScript）为基线，保持现有 UI 风格统一。

## 1. 目标与范围
- 在 /login 完成登录；登录成功后进入 /home。
- 登录态持久化到本地缓存（localStorage）。
- 未登录访问 /home 时，给出提示并跳转至 /login。
- 退出登录时清理本地登录态并跳转 /login。
- 与项目现有主题/样式保持一致；Windows 开发环境默认。


## 2. 路由与导航
- 路由：
  - GET /login — 登录页
  - GET /home — 登录后首页
- 导航规则：
  1) 未登录访问 /home：弹出轻提示（Toast/Alert）“请先登录”，随后 1.5s 内重定向至 /login。
  2) 登录成功：默认跳转 /home；若携带 redirect 参数或 history.state.from，则优先跳回原目标页。

## 3. 登录态定义与本地缓存方案
- 本地缓存使用 localStorage，Key 命名建议采用单一命名空间，便于管理与清理：
  - `auth.token: string` — 认证令牌（如 JWT）。
  - `auth.user: string` — 用户信息（JSON 字符串），建议仅保存必要字段（id, name, role）。
  - `auth.expiresAt: string` — 过期时间（ISO 字符串或毫秒时间戳）。
- 安全注意：
  - 不缓存密码/敏感原文。
  - 令牌若为 JWT，注意前端仅作存在性与过期时间的基础判断，权限校验以服务端为准。
  - 防 XSS：所有来自缓存的数据使用前需安全解析与校验字段类型。

## 4. 前端状态管理（Zustand，含持久化恢复）
- 应用启动时：
  1) 读取 localStorage 中的 `auth.token`、`auth.user`、`auth.expiresAt`。
  2) 若当前时间 <= expiresAt，初始化到 Zustand `authStore`；否则清理缓存并保持未登录态。
- 登录成功时：
  - 将后端返回的 token、用户信息、过期时间写入 localStorage 与 `authStore`；
  - 触发跳转逻辑（见 §2）。
- 退出登录：
  - 清空上述三项缓存与 `authStore`，跳转 /login。

## 5. 访问拦截（前端路由守卫）
- 在路由层对受保护页面（/home 及其子路由）应用 AuthGuard：
  1) 从 `authStore`（若为空则从 localStorage 恢复一次）读取 token 与 expiresAt；
  2) 若缺失或已过期：
     - 通过全局提示“请先登录”；
     - 记录当前目标路径（`redirect`）；
     - 重定向到 `/login?redirect=<encodeURIComponent(target)>`。
  3) 否则放行。

## 6. 后端接口约定（建议）
- 登录接口：
  - `POST /api/auth/login`
  - 请求体：`{ username: string, password: string }`
  - 响应体：`{ token: string, user: { id: string; name: string; role?: string }, expiresIn: number }`
    - 其中 `expiresIn` 为秒数；前端计算 `expiresAt = now + expiresIn * 1000`。
  - 失败：HTTP 401/400，统一返回 `ApiError` 格式（参考项目约定）。
- 用户信息（可选增强）：
  - `GET /api/auth/profile` — 需要携带 Authorization: Bearer <token>，用于启动时二次校验。
- 401 处理：
  - 服务端应对无效/过期令牌返回 401；前端全局拦截器收到 401 时执行登出并跳转 /login。

## 7. UI 与交互细节
- 登录页（/login）：
  - 表单字段：用户名、密码；键盘回车触发提交；必填校验与最小长度校验；
  - 提交状态：显示 Loading、禁用按钮；错误时在表单顶部/字段附近提示；
  - 成功：Toast “登录成功”，然后跳转（遵循 redirect）；
  - 保持现有 Tailwind/组件风格，注意暗/亮主题兼容。
- 首页（/home）：
  - 显示当前用户信息（如用户名）；
  - 顶部或用户菜单提供“退出登录”，点击后清理缓存并跳转 /login。
- 轻提示（Toast）
  - 未登录访问受限页时提示“请先登录”；
  - 登录成功/失败均通过一致的 Toast/UI 规范反馈。

## 8. 重定向策略
- 优先级：`location.state.from > URL redirect 查询参数 > 默认 /home`。
- 登录页读取 `redirect` 参数，登录成功后路由跳转至该地址；若不存在则跳 /home。

## 9. 伪代码参考（前端关键逻辑）

```ts
// 判定是否登录
function isAuthenticated() {
  const token = localStorage.getItem('auth.token');
  const exp = Number(localStorage.getItem('auth.expiresAt') || 0);
  return Boolean(token) && Date.now() <= exp;
}

// 路由守卫（示意）
function requireAuth(targetPath: string) {
  if (isAuthenticated()) return true;
  toast.warn('请先登录');
  navigate(`/login?redirect=${encodeURIComponent(targetPath)}`);
  return false;
}
```

## 10. 错误处理与边界情况
- 多标签页：
  - 建议监听 `storage` 事件，同步登出/登录状态变化。
- 令牌过期：
  - 前端检测到过期即清理并跳转；或由后端 401 驱动全局登出。
- 网络错误：
  - 登录接口网络异常需提示“网络异常，请稍后重试”。
- 安全：
  - 谨慎处理来自 localStorage 的数据；严禁在控制台打印敏感信息。

## 11. 验收标准（Acceptance Criteria）
1) 访问 /login 显示登录表单；输入合法凭据可成功登录并跳转 /home。
2) 登录成功后刷新页面，仍保持登录态并可访问 /home。
3) 未登录直接访问 /home 时，出现“请先登录”提示并被重定向至 /login。
4) 从 /home 退出登录后，立即清理本地缓存并跳转 /login；再次访问 /home 会被拦截。
5) 带 redirect 参数访问 /login，登录成功后返回指定页面。
6) 后端返回 401 时，前端能统一登出并跳转 /login。
7) UI 风格与现有主题、样式一致；暗/亮模式表现正常。

## 12. 测试建议
- 单元测试（前端）：
  - 登录表单校验；登录成功/失败；路由守卫逻辑；本地缓存读写；`storage` 事件同步。
- 集成测试（前端）：
  - 未登录访问受保护路由 → 提示 + 跳转；
  - 登录成功后访问受保护路由；
  - 重定向参数生效。
- 后端：
  - /api/auth/login 输入校验、成功/失败响应；
  - 受保护接口 401 行为；
  - （可选）/api/auth/profile 校验 token。

## 13. 扩展与后续规划（可选）
- “记住我”与持久化时长策略；刷新令牌（refresh token）。
- 使用 HttpOnly Cookie + CSRF 防护（若切换为服务端会话）。
- 细粒度权限控制（角色/资源/操作）。
- 统一的全局请求拦截与错误边界优化。


## 14. 默认管理员与兼容性说明

### 14.1 默认管理员与配置
- 默认管理员账号：`admin`。
- 配置位置：`config/config.jsonc`。
  - 建议在该文件中新增或复用管理员相关配置项，用于指定默认管理员账户；示例（仅供参考，按项目现有配置命名规范调整）：
    ```jsonc
    {
      // 仅示意：请根据现有配置结构命名
      "admin": { "defaultUsername": "admin" }
    }
    ```
  - 该配置用于提供默认管理员账号来源；实际鉴权仍以登录接口发放的 token 为准。


#### 14.1.1 扩展：多账号与密码配置
- `config/config.jsonc` 可配置多个默认账号与密码，用于本地开发或演示环境；生产环境不建议以明文形式保存密码。
- 建议结构示例（按现有配置风格调整命名与层级）：
  ```jsonc
  {
    "auth": {
      "defaultAccounts": [
        { "username": "admin",    "password": "admin123!", "role": "admin" },
        { "username": "operator", "password": "op123456",  "role": "operator" }
      ]
    }
  }
  ```
- 字段说明：
  - `username`: 账号名；
  - `password`: 账号密码（仅开发/演示用途，不建议提交到仓库）；
  - `role`（可选）：角色标识，便于前端展示或后端权限扩展。
- 使用约定：该配置仅作为默认账号来源或初始化用途，实际鉴权以后端 `/api/auth/login` 返回的 token 为准；如与后端用户库冲突，以后端为准。
- 安全建议：
  - 避免将含明文密码的配置提交到版本库；可通过 `.env` 或本地私有配置覆盖；
  - 如确需持久化，考虑对密码进行哈希或加密，并在后端进行校验。

### 14.2 新增前端页面统一 token 校验
- 本次新增的所有前端页面（尤其是管理类页面，如 `/admin/...` 等）必须接入登录 token 验证（复用 §5 路由守卫）。
- 校验失败行为：提示“请先登录”，随后跳转到 `/login`（可携带 `redirect` 参数）。
- 守卫实现建议：
  - 统一在路由层或页面级高阶组件中接入，避免分散重复实现；
  - 采用与 `/home` 一致的 `token` 与 `expiresAt` 判定逻辑；
  - 保持 UI/交互一致性（Toast/提示文案一致）。

### 14.3 不影响智能体对话功能
- 现有智能体对话功能（UI、路由、状态、请求）不得受新增登录校验的副作用影响：
  - 不修改对话相关既有路由与组件结构；
  - 不更改对话消息格式、状态存储与数据流；
  - 全局拦截器/守卫的改动需保证对话相关现有行为不变；
  - 若新增守卫通过“路由白名单/路径前缀”策略实现，应明确将对话相关既有页面纳入白名单或维持原有校验逻辑不变。
- 验收补充：
  - 在未登录与已登录两种状态下，进入对话相关页面的行为与既有版本一致；
  - 新增管理页面的登录校验不会阻塞或改变对话页面的可用性与性能。

---

本文档旨在在不侵入当前代码的前提下，对登录与访问控制的产品与技术需求进行清晰定义，便于后续一次性或增量实现。
