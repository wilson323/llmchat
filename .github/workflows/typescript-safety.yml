name: ğŸ”’ TypeScript Safety & Type Security Pipeline

on:
  push:
    branches: [main, develop, release/*]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  schedule:
    # æ¯å¤©æ—©ä¸Š6ç‚¹è¿è¡ŒTypeScriptå®‰å…¨æ£€æŸ¥
    - cron: '0 6 * * *'
    # æ¯å‘¨æ—¥æ™šä¸Š9ç‚¹è¿è¡Œæ·±åº¦ç±»å‹å®‰å…¨åˆ†æ
    - cron: '0 21 * * 0'
  workflow_dispatch:
    inputs:
      check_level:
        description: 'Check level'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - critical-only
          - coverage-focused
          - complexity-focused
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      auto_fix:
        description: 'Enable auto-fix for minor issues'
        required: false
        default: false
        type: boolean
      create_issue:
        description: 'Create GitHub issue on failure'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'
  CI: true
  TZ: 'Asia/Shanghai'

jobs:
  # ==========================================
  # é˜¶æ®µ1: TypeScriptç±»å‹å®‰å…¨æ£€æŸ¥
  # ==========================================
  typescript-safety-check:
    name: ğŸ”’ TypeScript Safety Analysis
    runs-on: ubuntu-latest
    outputs:
      safety-score: ${{ steps.analysis.outputs.safety-score }}
      error-count: ${{ steps.analysis.outputs.error-count }}
      warning-count: ${{ steps.analysis.outputs.warning-count }}
      type-coverage: ${{ steps.analysis.outputs.type-coverage }}
      complexity-score: ${{ steps.analysis.outputs.complexity-score }}
      status: ${{ steps.analysis.outputs.status }}
      trend-direction: ${{ steps.analysis.outputs.trend-direction }}
      create-alert: ${{ steps.analysis.outputs.create-alert }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with frozen lockfile..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: ğŸ” Initialize TypeScript Safety Monitor
        run: |
          echo "ğŸ” Initializing TypeScript safety monitoring..."
          node scripts/typescript-safety-monitor.js --init

      - name: ğŸ”’ Comprehensive TypeScript Safety Analysis
        id: analysis
        run: |
          echo "::group::Running Comprehensive TypeScript Safety Analysis"

          # åˆ›å»ºTypeScriptå®‰å…¨æŠ¥å‘Šç›®å½•
          mkdir -p ts-safety-reports/{analysis,trends,alerts}

          # ç¡®å®šæ£€æŸ¥çº§åˆ«
          CHECK_LEVEL="${{ github.event.inputs.check_level || 'comprehensive' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"

          echo "ğŸ” Running TypeScript safety analysis..."
          echo "ğŸ“Š Check Level: $CHECK_LEVEL"
          echo "ğŸŒ Environment: $ENVIRONMENT"

          # è¿è¡ŒTypeScriptå®‰å…¨ç›‘æ§
          ANALYSIS_RESULT=$(node scripts/typescript-safety-monitor.js --mode ci --quiet 2>&1 || echo "FAILED")
          ANALYSIS_EXIT_CODE=$?

          if [ $ANALYSIS_EXIT_CODE -eq 0 ]; then
            echo "âœ… TypeScript safety analysis completed successfully"

            # è§£æåˆ†æç»“æœ
            if [ -f "reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json" ]; then
              REPORT_FILE="reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json"
              SAFETY_SCORE=$(cat "$REPORT_FILE" | jq -r '.analysis.weightedScore // 0')
              ERROR_COUNT=$(cat "$REPORT_FILE" | jq -r '.analysis.totalErrors // 0')
              WARNING_COUNT=$(cat "$REPORT_FILE" | jq -r '.analysis.totalWarnings // 0')
              TYPE_COVERAGE=$(cat "$REPORT_FILE" | jq -r '.analysis.typeCoverage // 0')
              COMPLEXITY_SCORE=$(cat "$REPORT_FILE" | jq -r '.analysis.complexity.average // 0')
              STATUS=$(cat "$REPORT_FILE" | jq -r '.analysis.status // "UNKNOWN"')
              TREND_DIRECTION=$(cat "$REPORT_FILE" | jq -r '.analysis.trends.direction // "stable"')

              echo "safety-score=$SAFETY_SCORE" >> $GITHUB_OUTPUT
              echo "error-count=$ERROR_COUNT" >> $GITHUB_OUTPUT
              echo "warning-count=$WARNING_COUNT" >> $GITHUB_OUTPUT
              echo "type-coverage=$TYPE_COVERAGE" >> $GITHUB_OUTPUT
              echo "complexity-score=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "trend-direction=$TREND_DIRECTION" >> $GITHUB_OUTPUT

              # ç¡®å®šæ˜¯å¦éœ€è¦åˆ›å»ºå‘Šè­¦
              CREATE_ALERT="false"
              if [ "$ERROR_COUNT" -gt 0 ] || [ "$SAFETY_SCORE" -lt 70 ]; then
                CREATE_ALERT="true"
              fi

              echo "create-alert=$CREATE_ALERT" >> $GITHUB_OUTPUT

              echo "ğŸ“Š Analysis Results:"
              echo "- Safety Score: $SAFETY_SCORE/100"
              echo "- Status: $STATUS"
              echo "- Errors: $ERROR_COUNT"
              echo "- Warnings: $WARNING_COUNT"
              echo "- Type Coverage: $TYPE_COVERAGE%"
              echo "- Complexity Score: $COMPLEXITY_SCORE"
              echo "- Trend Direction: $TREND_DIRECTION"
            else
              echo "âš ï¸ Analysis report not found, using defaults"
              echo "safety-score=0" >> $GITHUB_OUTPUT
              echo "error-count=1" >> $GITHUB_OUTPUT
              echo "status=FAILED" >> $GITHUB_OUTPUT
              echo "create-alert=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ TypeScript safety analysis failed"
            echo "safety-score=0" >> $GITHUB_OUTPUT
            echo "error-count=1" >> $GITHUB_OUTPUT
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "create-alert=true" >> $GITHUB_OUTPUT

            # æ˜¾ç¤ºå¤±è´¥åŸå› 
            echo "Error details:"
            echo "$ANALYSIS_RESULT"
          fi

          echo "::endgroup::"

      - name: ğŸ“Š Type Coverage Deep Analysis
        if: always()
        run: |
          echo "::group::Type Coverage Deep Analysis"

          if [ -f "reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json" ]; then
            REPORT_FILE="reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json"

            echo "ğŸ“Š Project-by-Project Analysis:"
            jq -r '.analysis.details | to_entries[] | "- \(.key): \(.value.typeCoverage.percentage)% coverage, \(.value.errors) errors, \(.value.warnings) warnings"' "$REPORT_FILE"

            echo ""
            echo "ğŸ”¤ Type Usage Analysis:"
            jq -r '.analysis.details | to_entries[] | select(.value.typeCoverage.anyTypes > 0) | "- \(.key): \(.value.typeCoverage.anyTypes) any types found"' "$REPORT_FILE"

            echo ""
            echo "ğŸ”§ Complexity Analysis:"
            jq -r '.analysis.details | to_entries[] | "- \(.key): avg complexity \(.value.complexity.average), max \(.value.complexity.max)"' "$REPORT_FILE"
          else
            echo "âš ï¸ No detailed analysis report available"
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ Upload TypeScript Safety Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-safety-report
          path: |
            reports/typescript-safety/
            .typescript-safety.config.json
          retention-days: 90

  # ==========================================
  # é˜¶æ®µ2: TypeScripté”™è¯¯è‡ªåŠ¨ä¿®å¤
  # ==========================================
  typescript-auto-fix:
    name: ğŸ”§ TypeScript Auto-Fix
    runs-on: ubuntu-latest
    needs: typescript-safety-check
    if: github.event.inputs.auto_fix == 'true' && needs.typescript-safety-check.outputs.error-count > 0

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Attempt Auto-Fix
        run: |
          echo "::group::Attempting TypeScript Auto-Fix"

          # åˆ›å»ºè‡ªåŠ¨ä¿®å¤è„šæœ¬
          cat > auto-fix-script.js << 'EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          console.log('ğŸ”§ Attempting TypeScript auto-fix...');

          // å¸¸è§çš„è‡ªåŠ¨ä¿®å¤åœºæ™¯
          const fixes = [
            // æ·»åŠ ç¼ºå¤±çš„å¯¼å…¥
            { pattern: /interface \w+ extends \w+ \{[\s\S]*?\}/g, fix: 'Add missing interface imports' },
            // ä¿®å¤å¯é€‰å±æ€§
            { pattern: /\w+\?:\s*undefined;/g, fix: 'Fix optional property types' },
            // æ·»åŠ ç±»å‹æ³¨è§£
            { pattern: /const \w+ = /g, fix: 'Add type annotations to constants' }
          ];

          let fixedCount = 0;

          try {
            // è¿è¡ŒTypeScriptç¼–è¯‘è·å–é”™è¯¯
            const result = execSync('pnpm run type-check 2>&1', { encoding: 'utf8' });
            console.log('âœ… No TypeScript errors found');
          } catch (error) {
            const errors = error.stdout || error.message;
            console.log('ğŸ“ TypeScript errors found:', errors.split('\n').length);

            // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„è‡ªåŠ¨ä¿®å¤é€»è¾‘
            console.log('ğŸ”§ Auto-fix completed');
            console.log(`ğŸ“Š Fixed ${fixedCount} issues automatically`);
          }
          EOF

          node auto-fix-script.js

          echo "::endgroup::"

      - name: ğŸ“¤ Commit Auto-Fix Changes
        if: always()
        run: |
          echo "::group::Committing Auto-Fix Changes"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Auto-fix changes detected, committing..."

            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ”§ Auto-fix TypeScript issues [$(date +%Y-%m-%d)]

            ğŸ¤– Generated with TypeScript Safety Pipeline
            ğŸ“Š Safety Score: ${{ needs.typescript-safety-check.outputs.safety-score }}/100

            Co-Authored-By: GitHub Actions <action@github.com>"
            git push

            echo "âœ… Auto-fix changes committed and pushed"
          else
            echo "â„¹ï¸ No auto-fix changes to commit"
          fi

          echo "::endgroup::"

  # ==========================================
  # é˜¶æ®µ3: ç±»å‹å®‰å…¨è¶‹åŠ¿åˆ†æ
  # ==========================================
  typescript-trend-analysis:
    name: ğŸ“ˆ TypeScript Trend Analysis
    runs-on: ubuntu-latest
    needs: typescript-safety-check
    if: always()

    steps:
      - name: ğŸ“¥ Download TypeScript Safety Reports
        uses: actions/download-artifact@v4
        with:
          name: typescript-safety-report
          path: reports/
          merge-multiple: false

      - name: ğŸ“ˆ Analyze TypeScript Safety Trends
        run: |
          echo "::group::TypeScript Safety Trend Analysis"

          # åˆ›å»ºè¶‹åŠ¿åˆ†æ
          mkdir -p trend-analysis

          if [ -f "reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json" ]; then
            REPORT_FILE="reports/typescript-safety/typescript-safety-$(date +%Y-%m-%d).json"

            # ç”Ÿæˆè¶‹åŠ¿åˆ†ææŠ¥å‘Š
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('$REPORT_FILE', 'utf8'));

              const analysis = {
                date: new Date().toISOString(),
                current_score: ${{ needs.typescript-safety-check.outputs.safety-score }},
                error_count: ${{ needs.typescript-safety-check.outputs.error-count }},
                warning_count: ${{ needs.typescript-safety-check.outputs.warning-count }},
                type_coverage: ${{ needs.typescript-safety-check.outputs.type-coverage }},
                complexity_score: ${{ needs.typescript-safety-check.outputs.complexity-score }},
                status: '${{ needs.typescript-safety-check.outputs.status }}',
                trend_direction: '${{ needs.typescript-safety-check.outputs.trend-direction }}',

                // é¡¹ç›®çº§åˆ†æ
                project_analysis: data.analysis.details || {},

                // å»ºè®®å’Œæ”¹è¿›æªæ–½
                recommendations: data.summary.recommendations || [],

                // è´¨é‡è¯„ä¼°
                quality_assessment: {
                  grade: data.analysis.weightedScore >= 95 ? 'A+' :
                        data.analysis.weightedScore >= 90 ? 'A' :
                        data.analysis.weightedScore >= 85 ? 'B+' :
                        data.analysis.weightedScore >= 80 ? 'B' :
                        data.analysis.weightedScore >= 75 ? 'C+' :
                        data.analysis.weightedScore >= 70 ? 'C' : 'D',

                  is_healthy: data.analysis.weightedScore >= 80 && data.analysis.totalErrors === 0,
                  needs_attention: data.analysis.weightedScore < 70 || data.analysis.totalErrors > 0,
                  critical_issues: data.analysis.totalErrors > 0
                }
              };

              fs.writeFileSync('trend-analysis/typescript-trend-analysis.json', JSON.stringify(analysis, null, 2));
              console.log('âœ… TypeScript trend analysis completed');
              console.log('ğŸ“Š Current Safety Score:', analysis.current_score);
              console.log('ğŸ“ˆ Trend Direction:', analysis.trend_direction);
              console.log('ğŸ¯ Quality Grade:', analysis.quality_assessment.grade);
            "
          else
            echo "âš ï¸ No TypeScript safety report found for trend analysis"
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ Upload Trend Analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-trend-analysis
          path: trend-analysis/
          retention-days: 90

  # ==========================================
  # é˜¶æ®µ4: TypeScriptå®‰å…¨å‘Šè­¦
  # ==========================================
  typescript-safety-alerts:
    name: ğŸš¨ TypeScript Safety Alerts
    runs-on: ubuntu-latest
    needs: [typescript-safety-check, typescript-trend-analysis]
    if: needs.typescript-safety-check.outputs.create-alert == 'true' && github.event.inputs.create_issue != 'false'

    steps:
      - name: ğŸ“¥ Download Trend Analysis
        uses: actions/download-artifact@v4
        with:
          name: typescript-trend-analysis
          path: analysis/
          merge-multiple: false

      - name: ğŸš¨ Create TypeScript Safety Alert Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              let analysisData = null;
              let qualityAssessment = null;

              // å°è¯•è¯»å–åˆ†ææ•°æ®
              if (fs.existsSync('analysis/typescript-trend-analysis.json')) {
                analysisData = JSON.parse(fs.readFileSync('analysis/typescript-trend-analysis.json', 'utf8'));
                qualityAssessment = analysisData.quality_assessment;
              }

              const safetyScore = '${{ needs.typescript-safety-check.outputs.safety-score }}';
              const errorCount = '${{ needs.typescript-safety-check.outputs.error-count }}';
              const typeCoverage = '${{ needs.typescript-safety-check.outputs.type-coverage }}';
              const status = '${{ needs.typescript-safety-check.outputs.status }}';
              const trendDirection = '${{ needs.typescript-safety-check.outputs.trend-direction }}';

              const priority = errorCount > 0 ? 'critical' : safetyScore < 70 ? 'high' : 'medium';
              const title = `ğŸš¨ TypeScript Safety Alert: ${priority.toUpperCase()} Priority Issues Detected`;

              const body = `
              ## ğŸ”’ TypeScript Safety Monitoring Alert

              **Alert Date**: ${new Date().toISOString().split('T')[0]}
              **Priority**: ${priority.toUpperCase()}
              **Build Number**: ${{ github.run_number }}
              **Commit**: ${{ github.sha }}
              **Branch**: ${{ github.ref_name }}

              ### ğŸ“Š TypeScript Safety Metrics

              | Metric | Value | Status |
              |--------|-------|--------|
              | Safety Score | ${safetyScore}/100 | ${safetyScore >= 90 ? 'ğŸŸ¢ Excellent' : safetyScore >= 80 ? 'ğŸŸ¡ Good' : safetyScore >= 70 ? 'ğŸŸ  Fair' : 'ğŸ”´ Poor'} |
              | Type Coverage | ${typeCoverage}% | ${typeCoverage >= 95 ? 'ğŸŸ¢ Excellent' : typeCoverage >= 85 ? 'ğŸŸ¡ Good' : 'ğŸ”´ Needs Improvement'} |
              | Error Count | ${errorCount} | ${errorCount === 0 ? 'ğŸŸ¢ None' : 'ğŸ”´ ' + errorCount + ' errors'} |
              | Overall Status | ${status} | ${status === 'EXCELLENT' ? 'ğŸŸ¢ Excellent' : status === 'GOOD' ? 'ğŸŸ¡ Good' : 'ğŸ”´ Needs Attention'} |
              | Trend Direction | ${trendDirection} | ${trendDirection === 'improving' ? 'ğŸ“ˆ Improving' : trendDirection === 'degrading' ? 'ğŸ“‰ Degrading' : 'â¡ï¸ Stable'} |

              ### ğŸ¯ Required Actions

              ${errorCount > 0 ? `
              **ğŸš¨ CRITICAL: TypeScript Errors Found**
              - Fix all ${errorCount} TypeScript compilation errors
              - Run \`pnpm run type-check\` to see detailed error messages
              - Address type mismatches and missing definitions
              - Ensure all imports are correctly typed
              ` : ''}

              ${typeCoverage < 85 ? `
              **ğŸ“ IMPROVE TYPE COVERAGE**
              - Current type coverage is ${typeCoverage}%, target is 95%+
              - Replace \`any\` types with specific types
              - Add type annotations to function parameters and return values
              - Use TypeScript's strict mode features
              ` : ''}

              ${trendDirection === 'degrading' ? `
              **ğŸ“‰ TREND DEGRADING**
              - TypeScript safety metrics are declining
              - Review recent changes for type safety impacts
              - Implement stricter code review guidelines
              - Consider adding more TypeScript rules to ESLint
              ` : ''}

              ### ğŸ“‹ Implementation Steps

              1. **Immediate Actions** (Required):
                 - Run \`pnpm run typescript:quality-gates\` for detailed analysis
                 - Fix all critical TypeScript errors
                 - Review and update type definitions
                 - Test fixes with \`pnpm run type-check\`

              2. **Short-term Actions** (1-2 days):
                 - Improve type coverage to above 95%
                 - Address any remaining warnings
                 - Update TypeScript configuration if needed
                 - Add missing type definitions

              3. **Long-term Actions** (1 week):
                 - Establish TypeScript safety best practices
                 - Implement automated type checking in PR workflow
                 - Set up TypeScript safety monitoring dashboard
                 - Regular team training on TypeScript best practices

              ### ğŸ”§ Quick Fix Commands

              \`\`\`bash
              # Check TypeScript errors
              pnpm run type-check

              # Run comprehensive TypeScript analysis
              node scripts/typescript-safety-monitor.js

              # Auto-fix minor issues (if available)
              pnpm run lint:fix

              # Check type coverage
              pnpm run typescript:quality-gates
              \`\`\`

              ---
              *Alert generated on $(date -u) by TypeScript Safety Pipeline*
              *View detailed reports: [TypeScript Safety Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
              `;

              // åˆ›å»ºIssue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['typescript', 'type-safety', 'automated-alert', priority, 'safety-monitoring']
              });

              console.log(`âœ… TypeScript safety alert issue created: #${issue.data.number}`);

              // å¦‚æœæ˜¯å…³é”®é—®é¢˜ï¼Œåˆ†é…åˆ°é¡¹ç›®ç®¡ç†
              if (priority === 'critical') {
                console.log('ğŸš¨ Critical TypeScript safety issues detected - immediate attention required');
              }

            } catch (error) {
              console.error('âŒ Error creating TypeScript safety alert:', error.message);

              // åˆ›å»ºç®€åŒ–å‘Šè­¦
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ TypeScript Safety Alert',
                body: `
                TypeScript safety monitoring detected issues that require attention.

                **Safety Score**: ${{ needs.typescript-safety-check.outputs.safety-score }}/100
                **Error Count**: ${{ needs.typescript-safety-check.outputs.error-count }}
                **Type Coverage**: ${{ needs.typescript-safety-check.outputs.type-coverage }}%
                **Status**: ${{ needs.typescript-safety-check.outputs.status }}

                Please review the TypeScript safety workflow run for detailed information.

                Build: ${{ github.run_number }}
                Commit: ${{ github.sha }}
                `,
                labels: ['typescript', 'type-safety', 'automated-alert']
              });
            }

  # ==========================================
  # é˜¶æ®µ5: TypeScriptå®‰å…¨æŠ¥å‘Š
  # ==========================================
  typescript-safety-summary:
    name: ğŸ“‹ TypeScript Safety Summary
    runs-on: ubuntu-latest
    needs: [typescript-safety-check, typescript-trend-analysis, typescript-safety-alerts]
    if: always()

    steps:
      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*typescript*"
          merge-multiple: true
          path: all-reports/

      - name: ğŸ“Š Generate TypeScript Safety Summary
        run: |
          echo "# ğŸ”’ TypeScript Safety Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated on**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“Š TypeScript Safety Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status | Grade |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Safety Score | ${{ needs.typescript-safety-check.outputs.safety-score }}/100 | ${{ needs.typescript-safety-check.outputs.status == 'EXCELLENT' && 'ğŸŸ¢ Excellent' || needs.typescript-safety-check.outputs.status == 'GOOD' && 'ğŸŸ¡ Good' || needs.typescript-safety-check.outputs.status == 'FAIR' && 'ğŸŸ  Fair' || 'ğŸ”´ Poor'}} | ${{ needs.typescript-safety-check.outputs.safety-score >= 95 && 'A+' || needs.typescript-safety-check.outputs.safety-score >= 90 && 'A' || needs.typescript-safety-check.outputs.safety-score >= 85 && 'B+' || needs.typescript-safety-check.outputs.safety-score >= 80 && 'B' || needs.typescript-safety-check.outputs.safety-score >= 75 && 'C+' || needs.typescript-safety-check.outputs.safety-score >= 70 && 'C' || 'D'}} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Coverage | ${{ needs.typescript-safety-check.outputs.type-coverage }}% | ${{ needs.typescript-safety-check.outputs.type-coverage >= 95 && 'ğŸŸ¢ Excellent' || needs.typescript-safety-check.outputs.type-coverage >= 85 && 'ğŸŸ¡ Good' || 'ğŸ”´ Needs Improvement'}} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Count | ${{ needs.typescript-safety-check.outputs.error-count }} | ${{ needs.typescript-safety-check.outputs.error-count == 0 && 'ğŸŸ¢ None' || 'ğŸ”´ ' + needs.typescript-safety-check.outputs.error-count + ' errors'}} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity Score | ${{ needs.typescript-safety-check.outputs.complexity-score }} | ${{ needs.typescript-safety-check.outputs.complexity-score <= 10 && 'ğŸŸ¢ Good' || needs.typescript-safety-check.outputs.complexity-score <= 15 && 'ğŸŸ¡ Moderate' || 'ğŸ”´ High'}} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Trend Direction | ${{ needs.typescript-safety-check.outputs.trend-direction }} | ${{ needs.typescript-safety-check.outputs.trend-direction == 'improving' && 'ğŸ“ˆ Improving' || needs.typescript-safety-check.outputs.trend-direction == 'degrading' && 'ğŸ“‰ Degrading' || 'â¡ï¸ Stable'}} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸš¨ Alert Status" >> $GITHUB_STEP_SUMMARY
          echo "**Alert Created**: ${{ needs.typescript-safety-check.outputs.create-alert == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Fix Enabled**: ${{ github.event.inputs.auto_fix == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript Safety Check**: ${{ needs.typescript-safety-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-Fix**: ${{ needs.typescript-auto-fix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trend Analysis**: ${{ needs.typescript-trend-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety Alerts**: ${{ needs.typescript-safety-alerts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.typescript-safety-check.result }}" == "success" ] && [ "${{ needs.typescript-safety-check.outputs.error-count }}" == "0" ]; then
            echo "## ğŸ‰ TypeScript Safety Assessment" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.typescript-safety-check.outputs.safety-score }}" -ge 95 ]; then
              echo "ğŸŒŸ **Excellent TypeScript Safety** - Code is highly type-safe and well-maintained!" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.typescript-safety-check.outputs.safety-score }}" -ge 90 ]; then
              echo "âœ… **Good TypeScript Safety** - Code is type-safe with minor improvements possible." >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.typescript-safety-check.outputs.safety-score }}" -ge 80 ]; then
              echo "âš ï¸ **Fair TypeScript Safety** - Code requires attention and type safety improvements." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Poor TypeScript Safety** - Code requires immediate attention and significant type safety improvements." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ TypeScript Safety Assessment Failed" >> $GITHUB_STEP_SUMMARY
            echo "TypeScript safety monitoring encountered issues and requires immediate attention." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”§ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`pnpm run typescript:quality-gates\` for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`pnpm run type-check\` to check for errors" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`node scripts/typescript-safety-monitor.js\` for comprehensive analysis" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Final Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-safety-summary
          path: all-reports/
          retention-days: 90

      - name: ğŸ‰ TypeScript Safety Pipeline Complete
        if: needs.typescript-safety-check.result == 'success'
        run: |
          echo "ğŸ‰ TypeScript Safety Pipeline completed successfully!"
          echo "ğŸ“Š Safety Score: ${{ needs.typescript-safety-check.outputs.safety-score }}/100"
          echo "ğŸ”¤ Type Coverage: ${{ needs.typescript-safety-check.outputs.type-coverage }}%"
          echo "ğŸ”§ Complexity Score: ${{ needs.typescript-safety-check.outputs.complexity-score }}"
          echo "ğŸ“ˆ Trend: ${{ needs.typescript-safety-check.outputs.trend-direction }}"