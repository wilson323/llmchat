name: è´¨é‡æ£€æŸ¥æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  quality-check:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'

    - name: å®‰è£… pnpm
      run: |
        corepack enable
        pnpm --version

    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile

    - name: TypeScript ç±»åž‹æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡Œä¸¥æ ¼çš„ TypeScript ç±»åž‹æ£€æŸ¥..."

        # é¦–å…ˆæ£€æŸ¥ shared-types
        echo "ðŸ“¦ æ£€æŸ¥ shared-types..."
        cd shared-types && pnpm run build
        cd ..

        # æ£€æŸ¥åŽç«¯ TypeScript (ä¸¥æ ¼æ¨¡å¼)
        echo "ðŸ”§ æ£€æŸ¥åŽç«¯ TypeScript..."
        cd backend
        # è®¾ç½®ä¸¥æ ¼æ¨¡å¼çŽ¯å¢ƒå˜é‡
        export TS_NODE_COMPILER_OPTIONS='{"strict":true,"noImplicitAny":true,"strictNullChecks":true}'
        pnpm run type-check
        if [ $? -ne 0 ]; then
          echo "âŒ åŽç«¯ TypeScript ç±»åž‹æ£€æŸ¥å¤±è´¥"
          echo "ðŸ” è¿è¡Œè¯¦ç»†é”™è¯¯æ£€æŸ¥..."
          npx tsc --noEmit --pretty --listFiles | head -50
          exit 1
        fi
        cd ..

        # æ£€æŸ¥å‰ç«¯ TypeScript (ä¸¥æ ¼æ¨¡å¼)
        echo "ðŸŽ¨ æ£€æŸ¥å‰ç«¯ TypeScript..."
        cd frontend
        pnpm run type-check
        if [ $? -ne 0 ]; then
          echo "âŒ å‰ç«¯ TypeScript ç±»åž‹æ£€æŸ¥å¤±è´¥"
          echo "ðŸ” è¿è¡Œè¯¦ç»†é”™è¯¯æ£€æŸ¥..."
          npx tsc --noEmit --pretty --listFiles | head -50
          exit 1
        fi
        cd ..

        echo "âœ… æ‰€æœ‰ TypeScript ç±»åž‹æ£€æŸ¥é€šè¿‡"

    - name: TypeScript ä¸¥æ ¼è´¨é‡é—¨ç¦æ£€æŸ¥
      run: |
        echo "ðŸ”’ æ‰§è¡Œ TypeScript ä¸¥æ ¼è´¨é‡é—¨ç¦æ£€æŸ¥..."

        # ä½¿ç”¨ä¸“é—¨çš„è´¨é‡é—¨ç¦è„šæœ¬
        pnpm run typescript:quality-gates:ci
        if [ $? -ne 0 ]; then
          echo "âŒ TypeScript è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥"
          echo "ðŸš¨ é›¶å®¹å¿æ”¿ç­–: æ‰€æœ‰ç±»åž‹é”™è¯¯å¿…é¡»ä¿®å¤æ‰èƒ½åˆå¹¶åˆ°ä¸»åˆ†æ”¯"
          echo ""
          echo "ðŸ“‹ å¿«é€Ÿä¿®å¤å»ºè®®:"
          echo "1. è¿è¡Œ 'pnpm run typescript:quality-gates' æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
          echo "2. ä¿®å¤æ‰€æœ‰ TypeScript ç±»åž‹é”™è¯¯"
          echo "3. ç¡®ä¿ä¸¥æ ¼æ¨¡å¼æ£€æŸ¥é€šè¿‡"
          echo "4. é‡æ–°æäº¤ä»£ç "
          exit 1
        fi

        echo "âœ… TypeScript ä¸¥æ ¼è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡Œ ESLint æ£€æŸ¥..."
        pnpm run lint

    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "ðŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
        pnpm test

    - name: æž„å»ºé¡¹ç›®
      run: |
        echo "ðŸ—ï¸ æž„å»ºé¡¹ç›®..."
        pnpm run build

    - name: å®‰å…¨å®¡è®¡
      run: |
        echo "ðŸ”’ æ‰§è¡Œå®‰å…¨å®¡è®¡..."
        pnpm audit --audit-level high

    - name: è¿è¡Œè´¨é‡æ£€æŸ¥è„šæœ¬
      run: |
        echo "ðŸ“Š æ‰§è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥..."
        pnpm run quality-check

    - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
      if: always()
      run: |
        echo "ðŸ“ˆ ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
        pnpm run quality-metrics:ci

    - name: ç”Ÿæˆ TypeScript ç±»åž‹æ£€æŸ¥æŠ¥å‘Š
      if: always()
      run: |
        echo "ðŸ“Š ç”Ÿæˆ TypeScript ç±»åž‹æ£€æŸ¥æŠ¥å‘Š..."

        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p reports/typescript

        # ç”Ÿæˆè¯¦ç»†çš„ç±»åž‹æ£€æŸ¥æŠ¥å‘Š
        echo "ðŸ” åˆ†æž TypeScript ç¼–è¯‘ç»“æžœ..."

        # åŽç«¯ç±»åž‹æ£€æŸ¥æŠ¥å‘Š
        echo "ðŸ“ ç”ŸæˆåŽç«¯ TypeScript æŠ¥å‘Š..."
        cd backend
        npx tsc --noEmit --pretty --listEmittedFiles > ../reports/typescript/backend-typecheck.log 2>&1 || true
        echo "Backend TypeScript check completed at $(date)" > ../reports/typescript/backend-summary.txt
        cd ..

        # å‰ç«¯ç±»åž‹æ£€æŸ¥æŠ¥å‘Š
        echo "ðŸ“ ç”Ÿæˆå‰ç«¯ TypeScript æŠ¥å‘Š..."
        cd frontend
        npx tsc --noEmit --pretty --listEmittedFiles > ../reports/typescript/frontend-typecheck.log 2>&1 || true
        echo "Frontend TypeScript check completed at $(date)" > ../reports/typescript/frontend-summary.txt
        cd ..

        # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        cat > reports/typescript/typecheck-summary.json << 'EOF'
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "project": "llmchat",
          "checks": {
            "backend": {
              "status": "completed",
              "config": "tsconfig.json",
              "strict_mode": true
            },
            "frontend": {
              "status": "completed",
              "config": "tsconfig.json",
              "strict_mode": true
            },
            "shared_types": {
              "status": "completed",
              "config": "tsconfig.json"
            }
          },
          "quality_gates": {
            "zero_type_errors": true,
            "strict_mode_enabled": true,
            "ci_blocking": true
          }
        }
        EOF

        echo "âœ… TypeScript ç±»åž‹æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-${{ matrix.node-version }}
        path: |
          quality-report.json
          coverage/
          reports/
          reports/typescript/
        retention-days: 30

    - name: è¦†ç›–çŽ‡æŠ¥å‘Š
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  security-scan:
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¿è¡Œ Trivy æ¼æ´žæ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ä¸Šä¼  Trivy æ‰«æç»“æžœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  performance-check:
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'

    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile

    - name: æž„å»ºé¡¹ç›®
      run: pnpm run build

    - name: åˆ†æžåŒ…å¤§å°
      run: |
        echo "ðŸ“¦ åˆ†æžå‰ç«¯åŒ…å¤§å°..."
        cd frontend
        pnpm run build
        npx bundlesize

    - name: Lighthouse CI
      run: |
        echo "ðŸš€ æ‰§è¡Œ Lighthouse æ€§èƒ½æ£€æŸ¥..."
        npm install -g @lhci/cli
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    if: always()

    steps:
    - name: å‘é€é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
        # è¿™é‡Œå¯ä»¥æ·»åŠ  Slackã€é‚®ä»¶ç­‰é€šçŸ¥é€»è¾‘