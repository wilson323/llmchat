name: è´¨é‡æ£€æŸ¥å’ŒCI/CDæµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå…¨é¢è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: å®‰è£…pnpm
      run: |
        npm install -g pnpm@${{ env.PNPM_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        pnpm install --frozen-lockfile

    - name: TypeScriptç±»å‹æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
        pnpm run type-check

    - name: ESLintä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
        ESLINT_DEV=true pnpm run lint

    - name: å‰ç«¯æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
        cd frontend && npm run test -- --run --coverage --watchAll=false --passWithNoTests

    - name: åç«¯æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
        pnpm run backend:test

    - name: å®‰å…¨å®¡è®¡
      run: |
        echo "ğŸ›¡ï¸ è¿è¡Œå®‰å…¨å®¡è®¡..."
        pnpm audit --audit-level high

    - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
        node scripts/quality-metrics.js

    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-report
        path: |
          quality-report.json
          QUALITY_REPORT.md
        retention-days: 30

  # æ„å»ºæ£€æŸ¥
  build-check:
    runs-on: ubuntu-latest
    name: æ„å»ºæ£€æŸ¥
    needs: quality-check

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: å®‰è£…pnpm
      run: |
        npm install -g pnpm@${{ env.PNPM_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        pnpm install --frozen-lockfile

    - name: æ„å»ºå‰ç«¯
      run: |
        echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
        pnpm run frontend:build

    - name: æ„å»ºåç«¯
      run: |
        echo "ğŸ—ï¸ æ„å»ºåç«¯..."
        pnpm run backend:build

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          frontend/dist/
          backend/dist/
        retention-days: 7

  # E2Eæµ‹è¯•
  e2e-test:
    runs-on: ubuntu-latest
    name: E2Eæµ‹è¯•
    needs: [quality-check, build-check]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: å®‰è£…pnpm
      run: |
        npm install -g pnpm@${{ env.PNPM_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        pnpm install --frozen-lockfile

    - name: å®‰è£…Playwright
      run: |
        npx playwright install --with-deps

    - name: å¯åŠ¨åº”ç”¨æœåŠ¡
      run: |
        echo "ğŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡..."
        pnpm run build
        pnpm start &
        sleep 10

    - name: è¿è¡ŒE2Eæµ‹è¯•
      run: |
        echo "ğŸ­ è¿è¡ŒE2Eæµ‹è¯•..."
        pnpm run test:e2e

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-report
        path: |
          playwright-report/
          test-results/
        retention-days: 7

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    name: æ€§èƒ½æµ‹è¯•
    needs: [quality-check, build-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: å®‰è£…pnpm
      run: |
        npm install -g pnpm@${{ env.PNPM_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        pnpm install --frozen-lockfile

    - name: æ„å»ºåº”ç”¨
      run: |
        pnpm run build

    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥é›†æˆLighthouseæˆ–å…¶ä»–æ€§èƒ½æµ‹è¯•å·¥å…·
        npm run test:performance || echo "æ€§èƒ½æµ‹è¯•è·³è¿‡ - æœªé…ç½®"

  # éƒ¨ç½²å‡†å¤‡
  deploy-prep:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å‡†å¤‡
    needs: [quality-check, build-check, e2e-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: å®‰è£…pnpm
      run: |
        npm install -g pnpm@${{ env.PNPM_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        pnpm install --frozen-lockfile

    - name: ç”Ÿæˆéƒ¨ç½²åŒ…
      run: |
        echo "ğŸ“¦ ç”Ÿæˆéƒ¨ç½²åŒ…..."
        pnpm run build

    - name: åˆ›å»ºéƒ¨ç½²æ¸…å•
      run: |
        echo "ğŸ“‹ åˆ›å»ºéƒ¨ç½²æ¸…å•..."
        cat > deployment-manifest.json << EOF
        {
          "version": "${{ github.sha }}",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}",
          "author": "${{ github.actor }}",
          "qualityScore": "$(node -e 'console.log(JSON.parse(require(\"./quality-report.json\")).summary.score)' 2>/dev/null || echo '0')"
        }
        EOF

    - name: ä¸Šä¼ éƒ¨ç½²åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: |
          frontend/dist/
          backend/dist/
          deployment-manifest.json
        retention-days: 30

  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    runs-on: ubuntu-latest
    name: è´¨é‡é—¨ç¦æ£€æŸ¥
    needs: [quality-check]
    if: always()

    steps:
    - name: ä¸‹è½½è´¨é‡æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        name: quality-report
        path: ./

    - name: æ£€æŸ¥è´¨é‡é—¨ç¦
      run: |
        echo "ğŸšª æ£€æŸ¥è´¨é‡é—¨ç¦..."

        # è¯»å–è´¨é‡æŠ¥å‘Š
        QUALITY_SCORE=$(node -e 'const report = JSON.parse(require("fs").readFileSync("quality-report.json", "utf8")); console.log(report.summary.score)' 2>/dev/null || echo "0")

        echo "ğŸ“Š å½“å‰è´¨é‡è¯„åˆ†: $QUALITY_SCORE/100"

        # å®šä¹‰è´¨é‡é—¨ç¦æ ‡å‡†
        MIN_QUALITY_SCORE=70
        MAX_TYPE_ERRORS=0
        MAX_ESLINT_ERRORS=0
        MAX_CRITICAL_SECURITY=0

        # æ£€æŸ¥å„é¡¹æŒ‡æ ‡
        if [ "$QUALITY_SCORE" -lt "$MIN_QUALITY_SCORE" ]; then
          echo "âŒ è´¨é‡è¯„åˆ†ä¸è¾¾æ ‡: $QUALITY_SCORE < $MIN_QUALITY_SCORE"
          exit 1
        fi

        if [ "${{ needs.quality-check.result }}" != "success" ]; then
          echo "âŒ è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œé˜»æ­¢åˆå¹¶"
          exit 1
        fi

        echo "âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"

    - name: æ·»åŠ è´¨é‡å¾½ç« 
      if: github.event_name == 'push'
      run: |
        echo "ğŸ·ï¸ æ›´æ–°è´¨é‡å¾½ç« ..."
        # è¿™é‡Œå¯ä»¥é›†æˆå¾½ç« ç”ŸæˆæœåŠ¡
        QUALITY_SCORE=$(node -e 'const report = JSON.parse(require("fs").readFileSync("quality-report.json", "utf8")); console.log(report.summary.score)' 2>/dev/null || echo "0")
        echo "è´¨é‡è¯„åˆ†: $QUALITY_SCORE/100"

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    name: ç»“æœé€šçŸ¥
    needs: [quality-check, build-check, e2e-test, quality-gate]
    if: always()

    steps:
    - name: ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
      uses: actions/download-artifact@v4
      if: always()
      with:
        path: ./reports/

    - name: å‘é€é€šçŸ¥
      if: failure()
      run: |
        echo "ğŸ“¢ å‘é€å¤±è´¥é€šçŸ¥..."
        # è¿™é‡Œå¯ä»¥é›†æˆSlackã€é‚®ä»¶ç­‰é€šçŸ¥æœåŠ¡
        echo "CI/CDæµæ°´çº¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—"

  # æ¸…ç†
  cleanup:
    runs-on: ubuntu-latest
    name: æ¸…ç†æ—§å·¥ä»¶
    needs: [quality-check, build-check, e2e-test, deploy-prep]
    if: always() && github.event_name == 'schedule'

    steps:
    - name: æ¸…ç†æ—§å·¥ä»¶
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });

          const oldArtifacts = artifacts.data.artifacts
            .filter(artifact => {
              const createdDate = new Date(artifact.created_at);
              const daysOld = (Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24);
              return daysOld > 7; // åˆ é™¤7å¤©å‰çš„å·¥ä»¶
            });

          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
            console.log(`åˆ é™¤æ—§å·¥ä»¶: ${artifact.name}`);
          }