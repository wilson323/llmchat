name: ğŸ“Š Enterprise Quality Monitoring Dashboard

on:
  push:
    branches: [main, develop, release/*]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œè´¨é‡ç›‘æ§
    - cron: '0 8 * * *'
    # æ¯å‘¨æ—¥æ™šä¸Š8ç‚¹è¿è¡Œæ·±åº¦è´¨é‡æ£€æŸ¥
    - cron: '0 20 * * 0'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - security-focused
          - performance-focused
          - code-quality
      generate_report:
        description: 'Generate detailed report'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'
  CI: true
  TZ: 'Asia/Shanghai'

jobs:
  # ==========================================
  # é˜¶æ®µ1: ç¯å¢ƒå‡†å¤‡å’Œè´¨é‡æ•°æ®æ”¶é›†
  # ==========================================
  quality-data-collection:
    name: ğŸ“Š Quality Data Collection
    runs-on: ubuntu-latest
    outputs:
      quality-score: ${{ steps.analysis.outputs.quality-score }}
      security-score: ${{ steps.analysis.outputs.security-score }}
      performance-score: ${{ steps.analysis.outputs.performance-score }}
      trend-status: ${{ steps.analysis.outputs.trend-status }}
      alert-level: ${{ steps.analysis.outputs.alert-level }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with frozen lockfile..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: ğŸ” Environment Validation
        run: |
          echo "ğŸ” Validating build environment..."

          # éªŒè¯Node.jsç‰ˆæœ¬
          NODE_VERSION_CHECK=$(node -v | cut -d'v' -f2)
          echo "âœ… Node.js version: $NODE_VERSION_CHECK"

          # éªŒè¯pnpmç‰ˆæœ¬
          PNPM_VERSION_CHECK=$(pnpm -v)
          echo "âœ… pnpm version: $PNPM_VERSION_CHECK"

          # éªŒè¯å·¥ä½œåŒºé…ç½®
          if [ -f "pnpm-workspace.yaml" ] || [ -f "pnpm-workspace.yml" ]; then
            echo "âœ… pnpm workspace configuration found"
          else
            echo "âš ï¸ No pnpm workspace configuration found"
          fi

      - name: ğŸ“Š Comprehensive Quality Analysis
        id: analysis
        run: |
          echo "::group::Running Comprehensive Quality Analysis"

          # åˆ›å»ºè´¨é‡æŠ¥å‘Šç›®å½•
          mkdir -p quality-reports/{trends,metrics,alerts}

          # è¿è¡Œç»Ÿä¸€è´¨é‡é—¨ç¦
          echo "ğŸ” Running unified quality gates..."
          node scripts/unified-quality-gates.js \
            --mode comprehensive \
            --format json \
            --output quality-reports/metrics/current-quality.json \
            --trend-data quality-reports/trends/ \
            --thresholds-file .quality-thresholds.json || true

          # ç”Ÿæˆè´¨é‡è¶‹åŠ¿åˆ†æ
          echo "ğŸ“ˆ Analyzing quality trends..."
          node scripts/quality-trend-tracker.js \
            --input quality-reports/metrics/current-quality.json \
            --trend-dir quality-reports/trends/ \
            --output quality-reports/trends/trend-analysis.json || true

          # ç”Ÿæˆè´¨é‡ä»ªè¡¨æ¿
          echo "ğŸ“Š Generating quality dashboard..."
          node scripts/quality-dashboard.js \
            --data-dir quality-reports/ \
            --output quality-dashboard.html \
            --format html || true

          # æå–å…³é”®æŒ‡æ ‡
          if [ -f "quality-reports/metrics/current-quality.json" ]; then
            QUALITY_SCORE=$(cat quality-reports/metrics/current-quality.json | jq -r '.overall_score // 0')
            SECURITY_SCORE=$(cat quality-reports/metrics/current-quality.json | jq -r '.security_score // 0')
            PERFORMANCE_SCORE=$(cat quality-reports/metrics/current-quality.json | jq -r '.performance_score // 0')
            TREND_STATUS=$(cat quality-reports/trends/trend-analysis.json | jq -r '.trend_status // "unknown"')
            ALERT_LEVEL=$(cat quality-reports/metrics/current-quality.json | jq -r '.alert_level // "info"')

            echo "quality-score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
            echo "security-score=$SECURITY_SCORE" >> $GITHUB_OUTPUT
            echo "performance-score=$PERFORMANCE_SCORE" >> $GITHUB_OUTPUT
            echo "trend-status=$TREND_STATUS" >> $GITHUB_OUTPUT
            echo "alert-level=$ALERT_LEVEL" >> $GITHUB_OUTPUT

            echo "âœ… Quality analysis completed"
            echo "ğŸ“Š Quality Score: $QUALITY_SCORE/100"
            echo "ğŸ”’ Security Score: $SECURITY_SCORE/100"
            echo "âš¡ Performance Score: $PERFORMANCE_SCORE/100"
            echo "ğŸ“ˆ Trend Status: $TREND_STATUS"
            echo "ğŸš¨ Alert Level: $ALERT_LEVEL"
          else
            echo "quality-score=0" >> $GITHUB_OUTPUT
            echo "security-score=0" >> $GITHUB_OUTPUT
            echo "performance-score=0" >> $GITHUB_OUTPUT
            echo "trend-status=error" >> $GITHUB_OUTPUT
            echo "alert-level=critical" >> $GITHUB_OUTPUT
            echo "âŒ Quality analysis failed"
          fi

          echo "::endgroup::"

      - name: ğŸš¨ Quality Alert Assessment
        id: alerts
        run: |
          echo "::group::Quality Alert Assessment"

          QUALITY_SCORE="${{ steps.analysis.outputs.quality-score }}"
          SECURITY_SCORE="${{ steps.analysis.outputs.security-score }}"
          ALERT_LEVEL="${{ steps.analysis.outputs.alert-level }}"

          # è¯„ä¼°æ˜¯å¦éœ€è¦åˆ›å»ºå‘Šè­¦
          CREATE_ALERT="false"
          ALERT_PRIORITY="low"

          if [ "$ALERT_LEVEL" = "critical" ] || [ "$QUALITY_SCORE" -lt 60 ] || [ "$SECURITY_SCORE" -lt 70 ]; then
            CREATE_ALERT="true"
            ALERT_PRIORITY="critical"
          elif [ "$ALERT_LEVEL" = "warning" ] || [ "$QUALITY_SCORE" -lt 75 ] || [ "$SECURITY_SCORE" -lt 85 ]; then
            CREATE_ALERT="true"
            ALERT_PRIORITY="high"
          elif [ "$QUALITY_SCORE" -lt 85 ]; then
            CREATE_ALERT="true"
            ALERT_PRIORITY="medium"
          fi

          echo "create-alert=$CREATE_ALERT" >> $GITHUB_OUTPUT
          echo "alert-priority=$ALERT_PRIORITY" >> $GITHUB_OUTPUT

          echo "ğŸš¨ Alert Assessment:"
          echo "- Create Alert: $CREATE_ALERT"
          echo "- Alert Priority: $ALERT_PRIORITY"

          echo "::endgroup::"

      - name: ğŸ“¤ Upload Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: enterprise-quality-report
          path: |
            quality-reports/
            quality-dashboard.html
            .quality-thresholds.json
          retention-days: 90

  # ==========================================
  # é˜¶æ®µ2: è´¨é‡è¶‹åŠ¿åˆ†æå’Œé¢„è­¦
  # ==========================================
  quality-trend-analysis:
    name: ğŸ“ˆ Quality Trend Analysis
    runs-on: ubuntu-latest
    needs: quality-data-collection
    if: always()

    steps:
      - name: ğŸ“¥ Download Quality Reports
        uses: actions/download-artifact@v4
        with:
          name: enterprise-quality-report
          path: reports/
          merge-multiple: false

      - name: ğŸ“ˆ Advanced Trend Analysis
        run: |
          echo "::group::Advanced Quality Trend Analysis"

          # åˆ›å»ºè¶‹åŠ¿åˆ†ææŠ¥å‘Š
          mkdir -p trend-analysis

          if [ -f "reports/quality-reports/trends/trend-analysis.json" ]; then
            echo "ğŸ“ˆ Generating comprehensive trend report..."

            # ç”Ÿæˆè¶‹åŠ¿å¯è§†åŒ–æ•°æ®
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('reports/quality-reports/trends/trend-analysis.json', 'utf8'));

              const report = {
                analysis_date: new Date().toISOString(),
                current_metrics: {
                  quality_score: ${{ needs.quality-data-collection.outputs.quality-score }},
                  security_score: ${{ needs.quality-data-collection.outputs.security-score }},
                  performance_score: ${{ needs.quality-data-collection.outputs.performance-score }},
                  trend_status: '${{ needs.quality-data-collection.outputs.trend-status }}'
                },
                trend_analysis: data,
                recommendations: []
              };

              // ç”Ÿæˆæ”¹è¿›å»ºè®®
              if (report.current_metrics.quality_score < 80) {
                report.recommendations.push({
                  category: 'code_quality',
                  priority: 'high',
                  action: 'Increase test coverage and reduce code complexity',
                  impact: 'significantly improve overall code quality'
                });
              }

              if (report.current_metrics.security_score < 85) {
                report.recommendations.push({
                  category: 'security',
                  priority: 'critical',
                  action: 'Address security vulnerabilities and implement security best practices',
                  impact: 'improve application security posture'
                });
              }

              if (report.current_metrics.performance_score < 75) {
                report.recommendations.push({
                  category: 'performance',
                  priority: 'medium',
                  action: 'Optimize application performance and implement caching strategies',
                  impact: 'enhance user experience and reduce resource consumption'
                });
              }

              fs.writeFileSync('trend-analysis/quality-trend-report.json', JSON.stringify(report, null, 2));
              console.log('âœ… Trend analysis report generated');
            "

            echo "ğŸ“Š Trend analysis completed successfully"
          else
            echo "âš ï¸ No trend data available for analysis"
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ Upload Trend Analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-trend-analysis
          path: trend-analysis/
          retention-days: 90

  # ==========================================
  # é˜¶æ®µ3: è‡ªåŠ¨åŒ–é—®é¢˜åˆ›å»ºå’Œé€šçŸ¥
  # ==========================================
  quality-alerts:
    name: ğŸš¨ Quality Alerts & Notifications
    runs-on: ubuntu-latest
    needs: [quality-data-collection, quality-trend-analysis]
    if: needs.quality-data-collection.outputs.create-alert == 'true'

    steps:
      - name: ğŸ“¥ Download Trend Analysis
        uses: actions/download-artifact@v4
        with:
          name: quality-trend-analysis
          path: analysis/
          merge-multiple: false

      - name: ğŸš¨ Create Quality Alert Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const trendData = fs.readFileSync('analysis/quality-trend-report.json', 'utf8');
              const analysis = JSON.parse(trendData);

              const priority = '${{ needs.quality-data-collection.outputs.alert-priority }}';
              const qualityScore = '${{ needs.quality-data-collection.outputs.quality-score }}';
              const securityScore = '${{ needs.quality-data-collection.outputs.security-score }}';
              const performanceScore = '${{ needs.quality-data-collection.outputs.performance-score }}';

              const title = `ğŸš¨ Quality Alert: ${priority.toUpperCase()} Priority Issues Detected`;

              const body = `
              ## ğŸš¨ Quality Monitoring Alert

              **Alert Date**: ${new Date().toISOString().split('T')[0]}
              **Priority**: ${priority.toUpperCase()}
              **Build Number**: ${{ github.run_number }}
              **Commit**: ${{ github.sha }}
              **Branch**: ${{ github.ref_name }}

              ### ğŸ“Š Current Quality Metrics

              | Metric | Score | Status |
              |--------|-------|--------|
              | Overall Quality | ${qualityScore}/100 | ${qualityScore >= 80 ? 'âœ… Good' : qualityScore >= 60 ? 'âš ï¸ Warning' : 'âŒ Critical'} |
              | Security | ${securityScore}/100 | ${securityScore >= 85 ? 'âœ… Secure' : securityScore >= 70 ? 'âš ï¸ Moderate' : 'âŒ Critical'} |
              | Performance | ${performanceScore}/100 | ${performanceScore >= 75 ? 'âœ… Optimal' : performanceScore >= 50 ? 'âš ï¸ Needs Improvement' : 'âŒ Poor'} |

              ### ğŸ“ˆ Trend Analysis

              **Trend Status**: ${{ needs.quality-data-collection.outputs.trend-status }}

              ### ğŸ¯ Required Actions

              ${analysis.recommendations.map(rec =>
                `- **${rec.category.toUpperCase()}** (${rec.priority} priority)\n  - **Action**: ${rec.action}\n  - **Impact**: ${rec.impact}`
              ).join('\n\n')}

              ### ğŸ“‹ Next Steps

              1. **Immediate Actions** (${priority === 'critical' ? 'Required' : 'Recommended'}):
                 - Review and address ${priority} priority issues
                 - Assign tasks to responsible team members
                 - Set deadlines for resolution

              2. **Short-term Actions** (1-2 weeks):
                 - Monitor quality trends in subsequent builds
                 - Implement preventive measures
                 - Update quality standards if needed

              3. **Long-term Actions** (1-3 months):
                 - Establish quality improvement processes
                 - Implement automated quality gates
                 - Regular quality reviews and assessments

              ### ğŸ“Š Quality Trends

              This alert was generated by the automated quality monitoring system.
              Continuous monitoring helps maintain high code quality standards.

              ---
              *Alert generated on $(date -u) by LLMChat Quality Monitoring System*
              *View detailed reports: [Quality Dashboard](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
              `;

              // åˆ›å»ºIssue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['quality', 'automated-alert', priority, 'quality-monitoring']
              });

              console.log(`âœ… Quality alert issue created: #${issue.data.number}`);

              // å¦‚æœæ˜¯å…³é”®é—®é¢˜ï¼ŒåŒæ—¶åˆ›å»ºProject Card
              if (priority === 'critical') {
                try {
                  // è¿™é‡Œå¯ä»¥æ·»åŠ æ·»åŠ åˆ°Projectæ¿çš„é€»è¾‘
                  console.log('ğŸ“‹ Critical issue flagged for immediate attention');
                } catch (projectError) {
                  console.log('âš ï¸ Could not add to project board:', projectError.message);
                }
              }

            } catch (error) {
              console.error('âŒ Error creating quality alert:', error.message);

              // åˆ›å»ºç®€åŒ–çš„å‘Šè­¦
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ Quality Monitoring Alert',
                body: `
                Automated quality monitoring detected issues that require attention.

                **Quality Score**: ${{ needs.quality-data-collection.outputs.quality-score }}/100
                **Security Score**: ${{ needs.quality-data-collection.outputs.security-score }}/100
                **Alert Priority**: ${{ needs.quality-data-collection.outputs.alert-priority }}

                Please review the quality monitoring workflow run for detailed information.

                Build: ${{ github.run_number }}
                Commit: ${{ github.sha }}
                `,
                labels: ['quality', 'automated-alert']
              });
            }

  # ==========================================
  # é˜¶æ®µ4: è´¨é‡æ‘˜è¦å’ŒæŠ¥å‘Šç”Ÿæˆ
  # ==========================================
  quality-summary:
    name: ğŸ“‹ Quality Summary Report
    runs-on: ubuntu-latest
    needs: [quality-data-collection, quality-trend-analysis, quality-alerts]
    if: always()

    steps:
      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*-report*"
          merge-multiple: true
          path: all-reports/

      - name: ğŸ“Š Generate Comprehensive Summary
        run: |
          echo "# ğŸ“Š Enterprise Quality Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated on**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“ˆ Quality Metrics Overview" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score | Status | Trend |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Quality | ${{ needs.quality-data-collection.outputs.quality-score }}/100 | ${{ needs.quality-data-collection.outputs.quality-score >= 80 && 'âœ… Good' || needs.quality-data-collection.outputs.quality-score >= 60 && 'âš ï¸ Warning' || 'âŒ Critical' }} | ${{ needs.quality-data-collection.outputs.trend-status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.quality-data-collection.outputs.security-score }}/100 | ${{ needs.quality-data-collection.outputs.security-score >= 85 && 'âœ… Secure' || needs.quality-data-collection.outputs.security-score >= 70 && 'âš ï¸ Moderate' || 'âŒ Critical' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.quality-data-collection.outputs.performance-score }}/100 | ${{ needs.quality-data-collection.outputs.performance-score >= 75 && 'âœ… Optimal' || needs.quality-data-collection.outputs.performance-score >= 50 && 'âš ï¸ Needs Improvement' || 'âŒ Poor' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸš¨ Alert Status" >> $GITHUB_STEP_SUMMARY
          echo "**Alert Level**: ${{ needs.quality-data-collection.outputs.alert-level }}" >> $GITHUB_STEP_SUMMARY
          echo "**Alert Created**: ${{ needs.quality-data-collection.outputs.create-alert == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Priority**: ${{ needs.quality-data-collection.outputs.alert-priority || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Data Collection**: ${{ needs.quality-data-collection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trend Analysis**: ${{ needs.quality-trend-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Alerts**: ${{ needs.quality-alerts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality-data-collection.result }}" == "success" ]; then
            echo "## ğŸ‰ Overall Assessment" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.quality-data-collection.outputs.quality-score }}" -ge 90 ]; then
              echo "ğŸŒŸ **Excellent Quality** - System is performing at optimal levels!" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.quality-data-collection.outputs.quality-score }}" -ge 80 ]; then
              echo "âœ… **Good Quality** - System is performing well with minor improvements possible." >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.quality-data-collection.outputs.quality-score }}" -ge 70 ]; then
              echo "âš ï¸ **Acceptable Quality** - System requires attention and improvements." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Poor Quality** - System requires immediate attention and significant improvements." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ Quality Assessment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Quality monitoring system encountered issues and could not complete the assessment." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload Final Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-monitoring-summary
          path: all-reports/
          retention-days: 90