name: ğŸš€ Enterprise CI/CD Pipeline - LLMChat

on:
  push:
    branches: [main, develop, release/*]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  release:
    types: [published]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå…¨é¢æ‰«æ
    - cron: '0 2 * * *'
    # æ¯å‘¨æ—¥æ™šä¸Š8ç‚¹è¿è¡Œæ·±åº¦è´¨é‡æ£€æŸ¥
    - cron: '0 20 * * 0'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç›®æ ‡ç¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      security_scan:
        description: 'è¿è¡Œå…¨é¢å®‰å…¨æ‰«æ'
        required: false
        default: true
        type: boolean
      performance_test:
        description: 'è¿è¡Œæ€§èƒ½æµ‹è¯•'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯• (ä»…ç”¨äºç´§æ€¥ä¿®å¤)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'
  CI: true
  TZ: 'Asia/Shanghai'
  # è´¨é‡é˜ˆå€¼é…ç½®
  QUALITY_THRESHOLD_CODE: '85'
  QUALITY_THRESHOLD_TESTS: '80'
  QUALITY_THRESHOLD_SECURITY: '90'
  QUALITY_THRESHOLD_PERFORMANCE: '95'

# å…¨å±€æƒé™é…ç½®
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  issues: write
  packages: write
  deployments: write
  security-events: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ==========================================
  # é˜¶æ®µ1: ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–éªŒè¯
  # ==========================================
  setup-and-validate:
    name: ğŸš€ ç¯å¢ƒå‡†å¤‡ä¸éªŒè¯
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      node-version: ${{ env.NODE_VERSION }}
      should-run-security: ${{ steps.decide.outputs.should-run-security }}
      should-run-performance: ${{ steps.decide.outputs.should-run-performance }}
      is-release: ${{ steps.metadata.outputs.is-release }}
      version: ${{ steps.metadata.outputs.version }}
      build-number: ${{ steps.metadata.outputs.build-number }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ğŸ”§ è®¾ç½®Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ è·å–pnpmå­˜å‚¨ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ“¦ è®¾ç½®pnpmç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ ä½¿ç”¨frozen lockfileå®‰è£…ä¾èµ–..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: ğŸ” éªŒè¯ç¯å¢ƒé…ç½®
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."

          # æ£€æŸ¥Node.jsç‰ˆæœ¬
          NODE_VERSION_CHECK=$(node -v | cut -d'v' -f2)
          REQUIRED_VERSION="20.0.0"
          if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NODE_VERSION_CHECK" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
            echo "âŒ Node.jsç‰ˆæœ¬ $NODE_VERSION_CHECK ä½äºè¦æ±‚ç‰ˆæœ¬ $REQUIRED_VERSION"
            exit 1
          fi
          echo "âœ… Node.jsç‰ˆæœ¬æ£€æŸ¥é€šè¿‡: $NODE_VERSION_CHECK"

          # æ£€æŸ¥pnpmç‰ˆæœ¬
          PNPM_VERSION_CHECK=$(pnpm -v)
          echo "âœ… pnpmç‰ˆæœ¬: $PNPM_VERSION_CHECK"

          # éªŒè¯å·¥ä½œåŒºé…ç½®
          if [ ! -f "pnpm-workspace.yaml" ] && [ ! -f "pnpm-workspace.yml" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°pnpm workspaceé…ç½®"
          else
            echo "âœ… æ‰¾åˆ°pnpm workspaceé…ç½®"
          fi

          # éªŒè¯package.jsonç»“æ„
          if ! jq empty package.json 2>/dev/null; then
            echo "âŒ æ— æ•ˆçš„package.jsonæ ¼å¼"
            exit 1
          fi
          echo "âœ… package.jsonæ ¼å¼æœ‰æ•ˆ"

      - name: ğŸ“‹ æå–æ„å»ºå…ƒæ•°æ®
        id: metadata
        run: |
          echo "ğŸ“‹ æå–æ„å»ºå…ƒæ•°æ®..."

          # åˆ¤æ–­æ˜¯å¦ä¸ºrelease
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
            VERSION=${GITHUB_REF#refs/tags/}
          else
            echo "is-release=false" >> $GITHUB_OUTPUT
            VERSION="1.0.0-${{ github.run_number }}-${{ github.sha::8 }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=${{ github.run_number }}" >> $GITHUB_OUTPUT

          echo "âœ… æ„å»ºç‰ˆæœ¬: $VERSION"
          echo "âœ… æ„å»ºç¼–å·: ${{ github.run_number }}"

      - name: ğŸ¯ å†³å®šæ‰«æç­–ç•¥
        id: decide
        run: |
          # å†³å®šæ˜¯å¦è¿è¡Œå®‰å…¨æ‰«æ
          if [[ "${{ github.event_name }}" == "schedule" ]] || \
             [[ "${{ github.event.inputs.security_scan }}" == "true" ]] || \
             [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
             [[ "${{ github.event_name }}" == "release" ]]; then
            echo "should-run-security=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-security=false" >> $GITHUB_OUTPUT
          fi

          # å†³å®šæ˜¯å¦è¿è¡Œæ€§èƒ½æµ‹è¯•
          if [[ "${{ github.event.inputs.performance_test }}" == "true" ]] || \
             [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
             [[ "${{ github.event_name }}" == "release" ]]; then
            echo "should-run-performance=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-performance=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================
  # é˜¶æ®µ2: ä»£ç è´¨é‡æ£€æŸ¥ (å¹¶è¡Œæ‰§è¡Œ)
  # ==========================================
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    needs: setup-and-validate

    strategy:
      fail-fast: false
      matrix:
        check-type: [typescript, eslint, prettier, complexity]
        include:
          - check-type: typescript
            name: "TypeScriptç±»å‹æ£€æŸ¥"
            command: "pnpm run type-check"
            icon: "ğŸ“"
            critical: true
          - check-type: eslint
            name: "ESLintè´¨é‡æ£€æŸ¥"
            command: "pnpm run lint"
            icon: "ğŸ”"
            critical: true
          - check-type: prettier
            name: "Prettieræ ¼å¼æ£€æŸ¥"
            command: "pnpm prettier --check . || echo 'Prettier check not configured'"
            icon: "ğŸ¨"
            critical: false
          - check-type: complexity
            name: "ä»£ç å¤æ‚åº¦åˆ†æ"
            command: "echo 'Complexity analysis not implemented'"
            icon: "ğŸ“Š"
            critical: false

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ æ¢å¤pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ${{ matrix.icon }} ${{ matrix.name }}
        id: quality-check
        continue-on-error: ${{ !matrix.critical }}
        run: |
          echo "::group::${{ matrix.name }}"
          echo "è¿è¡Œå‘½ä»¤: ${{ matrix.command }}"

          # åˆ›å»ºè´¨é‡æŠ¥å‘Šç›®å½•
          mkdir -p quality-reports

          # è¿è¡Œæ£€æŸ¥å¹¶æ•è·ç»“æœ
          START_TIME=$(date +%s)

          if ${{ matrix.command }}; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            echo "${{ matrix.check-type }}_status=passed" >> $GITHUB_OUTPUT
            echo "${{ matrix.check-type }}_duration=$DURATION" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.name }} é€šè¿‡ (${DURATION}s)"
          else
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            echo "${{ matrix.check-type }}_status=failed" >> $GITHUB_OUTPUT
            echo "${{ matrix.check-type }}_duration=$DURATION" >> $GITHUB_OUTPUT
            echo "âŒ ${{ matrix.name }} å¤±è´¥ (${DURATION}s)"
            echo "::endgroup::"

            if [ "${{ matrix.critical }}" == "true" ]; then
              exit 1
            fi
          fi
          echo "::endgroup::"

      - name: ğŸ“Š ä¸Šä¼ è´¨é‡ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-results-${{ matrix.check-type }}
          path: |
            quality-reports/
            eslint-report.json
            tsconfig.json
            .eslintcache
          retention-days: 30

  # ==========================================
  # é˜¶æ®µ3: æµ‹è¯•å¥—ä»¶ (å¹¶è¡Œæ‰§è¡Œ)
  # ==========================================
  test-suite:
    name: ğŸ§ª æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: setup-and-validate
    if: github.event.inputs.skip_tests != 'true'

    strategy:
      fail-fast: false
      matrix:
        test-type: [unit-backend, unit-frontend, integration, e2e]
        include:
          - test-type: unit-backend
            name: "åç«¯å•å…ƒæµ‹è¯•"
            command: "cd backend && pnpm run test:ci"
            coverage: true
            icon: "ğŸ”¬"
            critical: true
          - test-type: unit-frontend
            name: "å‰ç«¯å•å…ƒæµ‹è¯•"
            command: "cd frontend && pnpm run test:coverage"
            coverage: true
            icon: "âš›ï¸"
            critical: true
          - test-type: integration
            name: "é›†æˆæµ‹è¯•"
            command: "pnpm run test:integration || echo 'Integration tests not configured'"
            coverage: false
            icon: "ğŸ”—"
            critical: false
          - test-type: e2e
            name: "ç«¯åˆ°ç«¯æµ‹è¯•"
            command: "pnpm run test:e2e"
            coverage: false
            icon: "ğŸŒ"
            critical: false
            setup: true

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ æ¢å¤pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸŒ è®¾ç½®E2Eä¾èµ–
        if: matrix.setup
        run: |
          pnpm exec playwright install --with-deps
          pnpm exec playwright install-deps

      - name: ${{ matrix.icon }} ${{ matrix.name }}
        id: test-run
        continue-on-error: ${{ !matrix.critical }}
        run: |
          echo "::group::${{ matrix.name }}"

          # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
          mkdir -p test-reports
          mkdir -p coverage

          # è¿è¡Œæµ‹è¯•
          START_TIME=$(date +%s)

          if ${{ matrix.command }}; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            echo "${{ matrix.test-type }}_status=passed" >> $GITHUB_OUTPUT
            echo "${{ matrix.test-type }}_duration=$DURATION" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.name }} é€šè¿‡ (${DURATION}s)"
          else
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            echo "${{ matrix.test-type }}_status=failed" >> $GITHUB_OUTPUT
            echo "${{ matrix.test-type }}_duration=$DURATION" >> $GITHUB_OUTPUT
            echo "âŒ ${{ matrix.name }} å¤±è´¥ (${DURATION}s)"
            echo "::endgroup::"

            if [ "${{ matrix.critical }}" == "true" ]; then
              exit 1
            fi
          fi
          echo "::endgroup::"

      - name: ğŸ“Š å¤„ç†è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.coverage && steps.test-run.outputs.${{ matrix.test-type }}_status == 'passed'
        run: |
          echo "ğŸ“Š å¤„ç†è¦†ç›–ç‡æŠ¥å‘Š..."

          # åˆå¹¶è¦†ç›–ç‡æŠ¥å‘Š
          if [ -f "coverage/lcov.info" ]; then
            echo "âœ… æ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Š"
            # ç”Ÿæˆè¦†ç›–ç‡æ‘˜è¦
            npx nyc report --reporter=text-summary > test-reports/coverage-summary.txt || true
            npx nyc report --reporter=json > test-reports/coverage-summary.json || true
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Š"
          fi

      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            test-reports/
            coverage/
            playwright-report/
            test-results/
          retention-days: 30

  # ==========================================
  # é˜¶æ®µ4: å®‰å…¨æ‰«æ
  # ==========================================
  security-scan:
    name: ğŸ”’ å®‰å…¨æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    needs: setup-and-validate
    if: needs.setup-and-validate.outputs.should-run-security == 'true'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ” ä¾èµ–å®‰å…¨å®¡è®¡
        id: audit
        run: |
          echo "::group::ä¾èµ–å®‰å…¨å®¡è®¡"

          # åˆ›å»ºå®‰å…¨æŠ¥å‘Šç›®å½•
          mkdir -p security-reports

          # è¿è¡Œå®‰å…¨å®¡è®¡
          if pnpm audit --audit-level moderate --json > security-reports/audit-report.json 2>/dev/null; then
            echo "audit_status=passed" >> $GITHUB_OUTPUT
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
          else
            # æå–æ¼æ´æ•°é‡
            VULNS=$(cat security-reports/audit-report.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
            echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT

            if [ "$VULNS" -eq 0 ]; then
              echo "audit_status=passed" >> $GITHUB_OUTPUT
              echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
            elif [ "$VULNS" -le 5 ]; then
              echo "audit_status=warning" >> $GITHUB_OUTPUT
              echo "âš ï¸ å‘ç° $VULNS ä¸ªä½/ä¸­å±æ¼æ´"
            else
              echo "audit_status=failed" >> $GITHUB_OUTPUT
              echo "ğŸš¨ å‘ç° $VULNS ä¸ªå®‰å…¨æ¼æ´"
              echo "::endgroup::"
              exit 1
            fi
          fi
          echo "::endgroup::"

      - name: ğŸ” ä»£ç å®‰å…¨åˆ†æ
        id: code-security
        run: |
          echo "::group::ä»£ç å®‰å…¨åˆ†æ"

          # å®‰è£…å®‰å…¨æ‰«æå·¥å…·
          npm install -g semgrep@latest

          # è¿è¡Œä»£ç å®‰å…¨æ£€æŸ¥
          echo "è¿è¡ŒSemgrepå®‰å…¨æ‰«æ..."
          semgrep --config=auto --json --output=security-reports/semgrep-report.json . || true

          # åˆ†æç»“æœ
          if [ -f "security-reports/semgrep-report.json" ]; then
            SEMGREP_ISSUES=$(cat security-reports/semgrep-report.json | jq '.results | length' 2>/dev/null || echo "0")
            echo "semgrep_issues=$SEMGREP_ISSUES" >> $GITHUB_OUTPUT

            if [ "$SEMGREP_ISSUES" -eq 0 ]; then
              echo "code_security_status=passed" >> $GITHUB_OUTPUT
              echo "âœ… æœªå‘ç°ä»£ç å®‰å…¨é—®é¢˜"
            elif [ "$SEMGREP_ISSUES" -le 10 ]; then
              echo "code_security_status=warning" >> $GITHUB_OUTPUT
              echo "âš ï¸ å‘ç° $SEMGREP_ISSUES ä¸ªä»£ç å®‰å…¨é—®é¢˜"
            else
              echo "code_security_status=failed" >> $GITHUB_OUTPUT
              echo "ğŸš¨ å‘ç° $SEMGREP_ISSUES ä¸ªä»£ç å®‰å…¨é—®é¢˜"
            fi
          else
            echo "code_security_status=skipped" >> $GITHUB_OUTPUT
            echo "â­ï¸ è·³è¿‡ä»£ç å®‰å…¨æ‰«æ"
          fi
          echo "::endgroup::"

      - name: ğŸ”’ å¯†é’¥æ‰«æ
        id: secret-scan
        run: |
          echo "::group::æ•æ„Ÿä¿¡æ¯æ‰«æ"

          # æ‰«ææ•æ„Ÿä¿¡æ¯
          echo "æ‰«æGitå†å²ä¸­çš„æ•æ„Ÿä¿¡æ¯..."

          # æ£€æŸ¥å¸¸è§æ•æ„Ÿæ–‡ä»¶æ¨¡å¼
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]{8,}" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" --exclude="*.log" > security-reports/secrets-scan.txt 2>/dev/null; then
            SECRETS_FOUND=$(wc -l < security-reports/secrets-scan.txt)
            echo "secrets_found=$SECRETS_FOUND" >> $GITHUB_OUTPUT

            if [ "$SECRETS_FOUND" -gt 0 ]; then
              echo "secret_status=warning" >> $GITHUB_OUTPUT
              echo "âš ï¸ å‘ç° $SECRETS_FOUND ä¸ªå¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
              echo "è¯·æ£€æŸ¥ security-reports/secrets-scan.txt æ–‡ä»¶"
            else
              echo "secret_status=passed" >> $GITHUB_OUTPUT
              echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
            fi
          else
            echo "secrets_found=0" >> $GITHUB_OUTPUT
            echo "secret_status=passed" >> $GITHUB_OUTPUT
            echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
          fi
          echo "::endgroup::"

      - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-reports/
          retention-days: 90

  # ==========================================
  # é˜¶æ®µ5: æ„å»ºéªŒè¯
  # ==========================================
  build-validation:
    name: ğŸ—ï¸ æ„å»ºéªŒè¯
    runs-on: ubuntu-latest
    needs: [setup-and-validate, code-quality]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ æ¢å¤pnpmç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        id: build
        run: |
          echo "::group::æ„å»ºåº”ç”¨"

          # åˆ›å»ºæ„å»ºæŠ¥å‘Šç›®å½•
          mkdir -p build-reports

          # è®°å½•æ„å»ºå¼€å§‹æ—¶é—´
          BUILD_START=$(date +%s)

          # è¿è¡Œæ„å»º
          if pnpm run build; then
            BUILD_END=$(date +%s)
            BUILD_DURATION=$((BUILD_END - BUILD_START))

            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "build_duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
            echo "âœ… æ„å»ºæˆåŠŸ (${BUILD_DURATION}s)"

            # åˆ†ææ„å»ºäº§ç‰©
            if [ -d "backend/dist" ]; then
              BACKEND_SIZE=$(du -sh backend/dist | cut -f1)
              BACKEND_FILES=$(find backend/dist -type f | wc -l)
              echo "backend_size=$BACKEND_SIZE" >> $GITHUB_OUTPUT
              echo "backend_files=$BACKEND_FILES" >> $GITHUB_OUTPUT
            fi

            if [ -d "frontend/dist" ]; then
              FRONTEND_SIZE=$(du -sh frontend/dist | cut -f1)
              FRONTEND_FILES=$(find frontend/dist -type f | wc -l)
              echo "frontend_size=$FRONTEND_SIZE" >> $GITHUB_OUTPUT
              echo "frontend_files=$FRONTEND_FILES" >> $GITHUB_OUTPUT
            fi

          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ æ„å»ºå¤±è´¥"
            echo "::endgroup::"
            exit 1
          fi
          echo "::endgroup::"

      - name: ğŸ“Š åˆ†ææ„å»ºäº§ç‰©
        if: steps.build.outputs.build_status == 'success'
        run: |
          echo "ğŸ“Š åˆ†ææ„å»ºäº§ç‰©..."

          # ç”Ÿæˆæ„å»ºåˆ†ææŠ¥å‘Š
          cat > build-reports/build-analysis.md << EOF
          # LLMChat æ„å»ºåˆ†ææŠ¥å‘Š

          ## æ„å»ºä¿¡æ¯
          - **æ„å»ºçŠ¶æ€**: ${{ steps.build.outputs.build_status }}
          - **æ„å»ºè€—æ—¶**: ${{ steps.build.outputs.build_duration }}s
          - **æ„å»ºç‰ˆæœ¬**: ${{ needs.setup-and-validate.outputs.version }}
          - **æ„å»ºç¼–å·**: ${{ needs.setup-and-validate.outputs.build-number }}

          ## æ„å»ºäº§ç‰©
          ### åç«¯
          - **å¤§å°**: ${{ steps.build.outputs.backend_size || 'N/A' }}
          - **æ–‡ä»¶æ•°**: ${{ steps.build.outputs.backend_files || 'N/A' }}

          ### å‰ç«¯
          - **å¤§å°**: ${{ steps.build.outputs.frontend_size || 'N/A' }}
          - **æ–‡ä»¶æ•°**: ${{ steps.build.outputs.frontend_files || 'N/A' }}

          ## æ„å»ºæ—¶é—´
          - **å¼€å§‹æ—¶é—´**: $(date -d "@$((BUILD_START))" -u '+%Y-%m-%d %H:%M:%S UTC')
          - **ç»“æŸæ—¶é—´**: $(date -d "@$((BUILD_END))" -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

          # åˆ—å‡ºä¸»è¦æ„å»ºäº§ç‰©
          echo "" >> build-reports/build-analysis.md
          echo "## ä¸»è¦æ–‡ä»¶" >> build-reports/build-analysis.md

          if [ -d "backend/dist" ]; then
            echo "" >> build-reports/build-analysis.md
            echo "### åç«¯ä¸»è¦æ–‡ä»¶" >> build-reports/build-analysis.md
            find backend/dist -name "*.js" -o -name "*.ts" | head -10 | sed 's/^/- /' >> build-reports/build-analysis.md
          fi

          if [ -d "frontend/dist" ]; then
            echo "" >> build-reports/build-analysis.md
            echo "### å‰ç«¯ä¸»è¦æ–‡ä»¶" >> build-reports/build-analysis.md
            find frontend/dist -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | sed 's/^/- /' >> build-reports/build-analysis.md
          fi

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/dist/
            frontend/dist/
            build-reports/
          retention-days: 7

  # ==========================================
  # é˜¶æ®µ6: è´¨é‡é—¨ç¦è¯„ä¼°
  # ==========================================
  quality-gates:
    name: ğŸ›¡ï¸ è´¨é‡é—¨ç¦è¯„ä¼°
    runs-on: ubuntu-latest
    needs: [code-quality, test-suite, security-scan, build-validation]
    if: always()

    outputs:
      overall-status: ${{ steps.assessment.outputs.overall-status }}
      quality-score: ${{ steps.assessment.outputs.quality-score }}
      deployment-ready: ${{ steps.assessment.outputs.deployment-ready }}
      quality-grade: ${{ steps.assessment.outputs.quality-grade }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“Š ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          pattern: "*-results-*"
          merge-multiple: true
          path: all-reports/

      - name: ğŸ›¡ï¸ è´¨é‡é—¨ç¦è¯„ä¼°
        id: assessment
        run: |
          echo "::group::è´¨é‡é—¨ç¦è¯„ä¼°"

          # åˆå§‹åŒ–åˆ†æ•°
          QUALITY_SCORE=100
          OVERALL_STATUS="passed"
          DEPLOYMENT_READY="true"

          # è¯„ä¼°ä»£ç è´¨é‡ (æƒé‡: 30%)
          echo "ğŸ” è¯„ä¼°ä»£ç è´¨é‡..."
          CODE_QUALITY_STATUS="${{ needs.code-quality.result }}"
          if [ "$CODE_QUALITY_STATUS" != "success" ]; then
            QUALITY_SCORE=$((QUALITY_SCORE - 30))
            OVERALL_STATUS="warning"
            echo "âš ï¸ æ£€æµ‹åˆ°ä»£ç è´¨é‡é—®é¢˜"
          else
            echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          fi

          # è¯„ä¼°æµ‹è¯•ç»“æœ (æƒé‡: 25%)
          echo "ğŸ§ª è¯„ä¼°æµ‹è¯•ç»“æœ..."
          TEST_STATUS="${{ needs.test-suite.result }}"
          if [ "$TEST_STATUS" != "success" ]; then
            QUALITY_SCORE=$((QUALITY_SCORE - 25))
            OVERALL_STATUS="failed"
            DEPLOYMENT_READY="false"
            echo "âŒ æ£€æµ‹åˆ°æµ‹è¯•å¤±è´¥"
          else
            echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
          fi

          # è¯„ä¼°å®‰å…¨æ‰«æ (æƒé‡: 20%)
          echo "ğŸ”’ è¯„ä¼°å®‰å…¨æ‰«æ..."
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          if [ "$SECURITY_STATUS" == "failure" ]; then
            QUALITY_SCORE=$((QUALITY_SCORE - 20))
            OVERALL_STATUS="failed"
            DEPLOYMENT_READY="false"
            echo "ğŸš¨ æ£€æµ‹åˆ°å®‰å…¨æ¼æ´"
          elif [ "$SECURITY_STATUS" == "success" ]; then
            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
          else
            echo "â­ï¸ å®‰å…¨æ‰«æå·²è·³è¿‡"
          fi

          # è¯„ä¼°æ„å»ºç»“æœ (æƒé‡: 25%)
          echo "ğŸ—ï¸ è¯„ä¼°æ„å»ºéªŒè¯..."
          BUILD_STATUS="${{ needs.build-validation.result }}"
          if [ "$BUILD_STATUS" != "success" ]; then
            QUALITY_SCORE=$((QUALITY_SCORE - 25))
            OVERALL_STATUS="failed"
            DEPLOYMENT_READY="false"
            echo "âŒ æ„å»ºéªŒè¯å¤±è´¥"
          else
            echo "âœ… æ„å»ºéªŒè¯é€šè¿‡"
          fi

          # ç¡®ä¿åˆ†æ•°ä¸ä½äº0
          if [ $QUALITY_SCORE -lt 0 ]; then
            QUALITY_SCORE=0
          fi

          # ç¡®å®šè´¨é‡ç­‰çº§
          if [ $QUALITY_SCORE -ge 95 ]; then
            QUALITY_GRADE="A+"
          elif [ $QUALITY_SCORE -ge 90 ]; then
            QUALITY_GRADE="A"
          elif [ $QUALITY_SCORE -ge 85 ]; then
            QUALITY_GRADE="B+"
          elif [ $QUALITY_SCORE -ge 80 ]; then
            QUALITY_GRADE="B"
          elif [ $QUALITY_SCORE -ge 70 ]; then
            QUALITY_GRADE="C"
          else
            QUALITY_GRADE="D"
          fi

          # è®¾ç½®è¾“å‡º
          echo "overall-status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "quality-score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          echo "deployment-ready=$DEPLOYMENT_READY" >> $GITHUB_OUTPUT
          echo "quality-grade=$QUALITY_GRADE" >> $GITHUB_OUTPUT

          echo "ğŸ“Š è´¨é‡åˆ†æ•°: $QUALITY_SCORE/100 (ç­‰çº§: $QUALITY_GRADE)"
          echo "ğŸš¦ æ€»ä½“çŠ¶æ€: $OVERALL_STATUS"
          echo "ğŸš€ éƒ¨ç½²å°±ç»ª: $DEPLOYMENT_READY"
          echo "::endgroup::"

      - name: ğŸ“‹ ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“‹ ç”Ÿæˆç»¼åˆè´¨é‡æŠ¥å‘Š..."

          mkdir -p final-reports

          cat > final-reports/quality-report.md << EOF
          # LLMChat CI/CD è´¨é‡æŠ¥å‘Š

          ## ğŸ“Š æ‰§è¡Œæ‘˜è¦
          - **è´¨é‡åˆ†æ•°**: ${{ steps.assessment.outputs.quality-score }}/100
          - **è´¨é‡ç­‰çº§**: ${{ steps.assessment.outputs.quality-grade }}
          - **æ€»ä½“çŠ¶æ€**: ${{ steps.assessment.outputs.overall-status }}
          - **éƒ¨ç½²å°±ç»ª**: ${{ steps.assessment.outputs.deployment-ready }}
          - **æ„å»ºç¼–å·**: ${{ github.run_number }}
          - **æäº¤SHA**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **è§¦å‘è€…**: ${{ github.event_name }}

          ## ğŸ›¡ï¸ è´¨é‡é—¨ç¦ç»“æœ

          ### ä»£ç è´¨é‡
          - **çŠ¶æ€**: ${{ needs.code-quality.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
          - **å½±å“**: ä»£ç å¯ç»´æŠ¤æ€§çš„å…³é”®å› ç´ 
          - **æƒé‡**: 30%

          ### æµ‹è¯•å¥—ä»¶
          - **çŠ¶æ€**: ${{ needs.test-suite.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
          - **å½±å“**: åŠŸèƒ½ä¿è¯çš„å…³é”®å› ç´ 
          - **æƒé‡**: 25%

          ### å®‰å…¨æ‰«æ
          - **çŠ¶æ€**: ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || needs.security-scan.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}
          - **å½±å“**: ç”Ÿäº§å®‰å…¨çš„å…³é”®å› ç´ 
          - **æƒé‡**: 20%

          ### æ„å»ºéªŒè¯
          - **çŠ¶æ€**: ${{ needs.build-validation.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
          - **å½±å“**: éƒ¨ç½²å°±ç»ªçš„å…³é”®å› ç´ 
          - **æƒé‡**: 25%

          ## ğŸ¯ å»ºè®®

          ${{ steps.assessment.outputs.quality-score >= 95 && 'ğŸŒŸğŸŒŸğŸŒŸ ä¼˜ç§€è´¨é‡ï¼å‡†å¤‡ç”Ÿäº§éƒ¨ç½²ã€‚' || '' }}
          ${{ steps.assessment.outputs.quality-score >= 90 && steps.assessment.outputs.quality-score < 95 && 'ğŸŒŸğŸŒŸ å¾ˆå¥½è´¨é‡ï¼è€ƒè™‘åœ¨ç”Ÿäº§éƒ¨ç½²å‰è¿›è¡Œå°æ”¹è¿›ã€‚' || '' }}
          ${{ steps.assessment.outputs.quality-score >= 80 && steps.assessment.outputs.quality-score < 90 && 'âœ… è‰¯å¥½è´¨é‡ã€‚åœ¨ç”Ÿäº§éƒ¨ç½²å‰è§£å†³å…³é”®é—®é¢˜ã€‚' || '' }}
          ${{ steps.assessment.outputs.quality-score >= 70 && steps.assessment.outputs.quality-score < 80 && 'âš ï¸ å¯æ¥å—è´¨é‡ã€‚éœ€è¦é‡å¤§æ”¹è¿›æ‰èƒ½ç”Ÿäº§éƒ¨ç½²ã€‚' || '' }}
          ${{ steps.assessment.outputs.quality-score < 70 && 'âŒ è´¨é‡ä¸ä½³ã€‚éœ€è¦é‡å¤§æ”¹è¿›æ‰èƒ½éƒ¨ç½²ã€‚' || '' }}

          ## ğŸ“ˆ è¯¦ç»†æŒ‡æ ‡

          ### æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ needs.setup-and-validate.outputs.version }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **æäº¤è€…**: ${{ github.actor }}
          - **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### è´¨é‡è¶‹åŠ¿
          - **å½“å‰åˆ†æ•°**: ${{ steps.assessment.outputs.quality-score }}/100
          - **ç›®æ ‡åˆ†æ•°**: 90/100 (ç”Ÿäº§ç¯å¢ƒ)
          - **æ”¹è¿›ç©ºé—´**: ${{ 90 - steps.assessment.outputs.quality-score > 0 && 90 - steps.assessment.outputs.quality-score || 0 }}åˆ†

          ---
          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *ç”± LLMChat CI/CD æµæ°´çº¿æä¾›æ”¯æŒ*
          EOF

      - name: ğŸ“¤ ä¸Šä¼ æœ€ç»ˆæŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-quality-report
          path: final-reports/
          retention-days: 90

      - name: ğŸš« è´¨é‡é—¨ç¦å¼ºåˆ¶æ‰§è¡Œ
        if: steps.assessment.outputs.overall-status == 'failed'
        run: |
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ - é˜»æ­¢éƒ¨ç½²"
          echo "ğŸ“Š è´¨é‡åˆ†æ•°: ${{ steps.assessment.outputs.quality-score }}/100"
          echo "ğŸš¦ æ€»ä½“çŠ¶æ€: ${{ steps.assessment.outputs.overall-status }}"
          exit 1

      - name: ğŸ’¬ PRè´¨é‡è¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const reportPath = 'final-reports/quality-report.md';
              if (fs.existsSync(reportPath)) {
                const report = fs.readFileSync(reportPath, 'utf8');

                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ğŸ›¡ï¸ CI/CD è´¨é‡æŠ¥å‘Š\n\n${report}`
                });

                console.log('âœ… è´¨é‡æŠ¥å‘Šå·²è¯„è®ºåˆ°PR');
              }
            } catch (error) {
              console.log('âŒ è¯„è®ºPRæ—¶å‡ºé”™:', error.message);
            }

  # ==========================================
  # é˜¶æ®µ7: éƒ¨ç½²æµæ°´çº¿
  # ==========================================
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [setup-and-validate, quality-gates]
    if: needs.quality-gates.outputs.deployment-ready == 'true' && github.event_name != 'pull_request'
    environment:
      name: ${{ github.event.inputs.environment || 'development' }}
      url: ${{ steps.deploy.outputs.url }}

    strategy:
      matrix:
        environment: [development, staging, production]
        include:
          - environment: development
            branch: develop
            required_score: 70
            url_template: "https://dev.llmchat.example.com"
          - environment: staging
            branch: main
            required_score: 80
            url_template: "https://staging.llmchat.example.com"
          - environment: production
            branch: main
            required_score: 90
            url_template: "https://llmchat.example.com"
        exclude:
          - environment: production
            branch: develop
          - environment: staging
            branch: develop
          - environment: development
            branch: main

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./

      - name: ğŸš€ éƒ¨ç½²åˆ° ${{ matrix.environment }}
        id: deploy
        run: |
          echo "::group::éƒ¨ç½²åˆ° ${{ matrix.environment }}"

          # éªŒè¯éƒ¨ç½²æ¡ä»¶
          QUALITY_SCORE=${{ needs.quality-gates.outputs.quality-score }}
          REQUIRED_SCORE=${{ matrix.required_score }}

          if [ "$QUALITY_SCORE" -lt "$REQUIRED_SCORE" ]; then
            echo "âŒ è´¨é‡åˆ†æ•° $QUALITY_SCORE ä½äº ${{ matrix.environment }} ç¯å¢ƒè¦æ±‚çš„ $REQUIRED_SCORE"
            exit 1
          fi

          echo "âœ… è´¨é‡åˆ†æ•° $QUALITY_SCORE æ»¡è¶³ ${{ matrix.environment }} ç¯å¢ƒè¦æ±‚"

          # éƒ¨ç½²é€»è¾‘ï¼ˆç¤ºä¾‹ï¼‰
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° ${{ matrix.environment }}..."

          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šDockeréƒ¨ç½²ã€K8séƒ¨ç½²ã€äº‘æœåŠ¡éƒ¨ç½²ç­‰

          # è®¾ç½®éƒ¨ç½²URL
          DEPLOY_URL="${{ matrix.url_template }}"
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

          # åˆ›å»ºéƒ¨ç½²ä¿¡æ¯
          cat > deployment-info.json << EOF
          {
            "environment": "${{ matrix.environment }}",
            "version": "${{ needs.setup-and-validate.outputs.version }}",
            "build_number": "${{ needs.setup-and-validate.outputs.build-number }}",
            "commit_sha": "${{ github.sha }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "url": "$DEPLOY_URL",
            "quality_score": $QUALITY_SCORE
          }
          EOF

          echo "âœ… éƒ¨ç½²åˆ° ${{ matrix.environment }} å®Œæˆ"
          echo "ğŸ”— è®¿é—®åœ°å€: $DEPLOY_URL"
          echo "::endgroup::"

      - name: ğŸ” éƒ¨ç½²åå¥åº·æ£€æŸ¥
        run: |
          echo "::group::éƒ¨ç½²åå¥åº·æ£€æŸ¥"

          # ç­‰å¾…éƒ¨ç½²å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30

          # å¥åº·æ£€æŸ¥
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"
          if [ -n "$DEPLOY_URL" ]; then
            echo "ğŸ” æ£€æŸ¥å¥åº·çŠ¶æ€: $DEPLOY_URL"

            # æ£€æŸ¥APIå¥åº·çŠ¶æ€
            echo "æ£€æŸ¥APIå¥åº·çŠ¶æ€..."
            if curl -f "$DEPLOY_URL/api/health" --max-time 30 --retry 3 --retry-delay 10; then
              echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi

            # æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€
            echo "æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€..."
            if curl -f "$DEPLOY_URL" --max-time 30 --retry 3 --retry-delay 10; then
              echo "âœ… å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
          else
            echo "âš ï¸ æœªæä¾›éƒ¨ç½²URLï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
          fi

          echo "::endgroup::"

      - name: ğŸ“Š éƒ¨ç½²æŒ‡æ ‡
        run: |
          echo "::group::éƒ¨ç½²æŒ‡æ ‡"

          echo "ğŸ“Š ${{ matrix.environment }} ç¯å¢ƒéƒ¨ç½²æŒ‡æ ‡:"
          echo "- ç¯å¢ƒ: ${{ matrix.environment }}"
          echo "- è´¨é‡åˆ†æ•°: ${{ needs.quality-gates.outputs.quality-score }}/100"
          echo "- è¦æ±‚åˆ†æ•°: ${{ matrix.required_score }}"
          echo "- éƒ¨ç½²URL: ${{ steps.deploy.outputs.url }}"
          echo "- éƒ¨ç½²æ—¶é—´: $(date -u)"
          echo "- æ„å»ºç¼–å·: ${{ github.run_number }}"
          echo "- æäº¤SHA: ${{ github.sha }}"
          echo "- ç‰ˆæœ¬: ${{ needs.setup-and-validate.outputs.version }}"

          echo "::endgroup::"

      - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          echo "::group::éƒ¨ç½²é€šçŸ¥"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ${{ matrix.environment }} ç¯å¢ƒéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo "ğŸ”— è®¿é—®åœ°å€: ${{ steps.deploy.outputs.url }}"

            # è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥é€»è¾‘
            # ä¾‹å¦‚ï¼šSlackã€Teamsã€é‚®ä»¶ç­‰

          else
            echo "âŒ ${{ matrix.environment }} ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
            echo "ğŸ” è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—"

            # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘
          fi

          echo "::endgroup::"

  # ==========================================
  # é˜¶æ®µ8: æ€§èƒ½æµ‹è¯• (å¯é€‰)
  # ==========================================
  performance-test:
    name: ğŸ“Š æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [setup-and-validate, deploy]
    if: needs.setup-and-validate.outputs.should-run-performance == 'true' && needs.deploy.result == 'success'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-and-validate.outputs.node-version }}

      - name: ğŸ“¦ å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
        run: |
          npm install -g artillery
          npm install -g lighthouse

      - name: ğŸš€ APIæ€§èƒ½æµ‹è¯•
        run: |
          echo "::group::APIæ€§èƒ½æµ‹è¯•"

          # åˆ›å»ºæ€§èƒ½æµ‹è¯•é…ç½®
          cat > artillery-config.yml << EOF
          config:
            target: '\${{ needs.deploy.outputs.url }}/api'
            phases:
              - duration: 60
                arrivalRate: 10
              - duration: 120
                arrivalRate: 20
              - duration: 60
                arrivalRate: 5

          scenarios:
            - name: "APIè´Ÿè½½æµ‹è¯•"
              weight: 70
              requests:
                - get:
                    url: "/health"
                - get:
                    url: "/agents"
            - name: "APIå‹åŠ›æµ‹è¯•"
              weight: 30
              requests:
                - post:
                    url: "/chat/completions"
                    json:
                      model: "test"
                      messages: [{"role": "user", "content": "Hello"}]
          EOF

          # è¿è¡ŒAPIæ€§èƒ½æµ‹è¯•
          artillery run artillery-config.yml --output performance-results.json

          echo "::endgroup::"

      - name: ğŸŒ å‰ç«¯æ€§èƒ½æµ‹è¯•
        run: |
          echo "::group::å‰ç«¯æ€§èƒ½æµ‹è¯•"

          # åˆ›å»ºLighthouseé…ç½®
          mkdir -p lighthouse-reports

          # è¿è¡ŒLighthouseæµ‹è¯•
          DEPLOY_URL="${{ needs.deploy.outputs.url }}"
          lighthouse "$DEPLOY_URL" \
            --output=json --output-path=./lighthouse-reports/report.json \
            --chrome-flags="--headless --no-sandbox" \
            --quiet

          echo "::endgroup::"

      - name: ğŸ“Š æ€§èƒ½åˆ†æ
        run: |
          echo "::group::æ€§èƒ½åˆ†æ"

          # åˆ†æAPIæ€§èƒ½ç»“æœ
          if [ -f "performance-results.json" ]; then
            echo "ğŸ“Š APIæ€§èƒ½ç»“æœ:"
            jq '.aggregate | {rps: .http.responses, latency: .latency, errors: .errors}' performance-results.json
          fi

          # åˆ†æå‰ç«¯æ€§èƒ½ç»“æœ
          if [ -f "lighthouse-reports/report.json" ]; then
            echo "ğŸŒ å‰ç«¯æ€§èƒ½ç»“æœ:"
            jq '.lhrCategories | {performance: .performance.score, accessibility: .accessibility.score, "best-practices": .["best-practices"].score, seo: .seo.score}' lighthouse-reports/report.json
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            performance-results.json
            lighthouse-reports/
          retention-days: 30

  # ==========================================
  # é˜¶æ®µ9: é€šçŸ¥å’ŒæŠ¥å‘Š
  # ==========================================
  notify-and-report:
    name: ğŸ“¢ é€šçŸ¥å’ŒæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [quality-gates, deploy, performance-test]
    if: always()

    steps:
      - name: ğŸ“Š ä¸‹è½½æœ€ç»ˆæŠ¥å‘Š
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: final-quality-report
          path: final-report/

      - name: ğŸ“¢ æµæ°´çº¿æ‘˜è¦
        if: always()
        run: |
          echo "# ğŸš€ LLMChat CI/CD æµæ°´çº¿æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š æµæ°´çº¿ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **è´¨é‡é—¨ç¦**: ${{ needs.quality-gates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è´¨é‡åˆ†æ•°**: ${{ needs.quality-gates.outputs.quality-score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **è´¨é‡ç­‰çº§**: ${{ needs.quality-gates.outputs.quality-grade }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²**: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€§èƒ½æµ‹è¯•**: ${{ needs.performance-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºç¼–å·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality-gates.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "## ğŸ‰ æ€»ä½“çŠ¶æ€: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æµæ°´çº¿æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ æ€»ä½“çŠ¶æ€: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "âŒ æµæ°´çº¿å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ è¯¦ç»†ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºéªŒè¯**: ${{ needs.build-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»£ç è´¨é‡**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•å¥—ä»¶**: ${{ needs.test-suite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®‰å…¨æ‰«æ**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY

          # æ·»åŠ è´¨é‡ç­‰çº§è¯´æ˜
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ† è´¨é‡ç­‰çº§è¯´æ˜" >> $GITHUB_STEP_SUMMARY
          echo "- **A+ (95-100åˆ†)**: ä¼˜ç§€è´¨é‡ï¼Œå‡†å¤‡ç”Ÿäº§éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- **A (90-94åˆ†)**: å¾ˆå¥½è´¨é‡ï¼Œé€‚åˆç”Ÿäº§éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- **B+ (85-89åˆ†)**: è‰¯å¥½è´¨é‡ï¼Œå¯éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **B (80-84åˆ†)**: å¯æ¥å—è´¨é‡ï¼Œéœ€è¦æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "- **C (70-79åˆ†)**: ä¸€èˆ¬è´¨é‡ï¼Œéœ€è¦é‡å¤§æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "- **D (<70åˆ†)**: è´¨é‡ä¸ä½³ï¼Œä¸å»ºè®®éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥
        if: needs.quality-gates.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥..."

          # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶ã€Slackã€Teamsç­‰é€šçŸ¥é€»è¾‘
          echo "æµæ°´çº¿å¤±è´¥ - é€šçŸ¥å·²å‘é€"

          # ç¤ºä¾‹Slacké€šçŸ¥
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ LLMChat CI/CD æµæ°´çº¿å¤±è´¥ï¼\nåˆ†æ”¯: ${{ github.ref_name }}\næäº¤: ${{ github.sha }}\nè´¨é‡åˆ†æ•°: ${{ needs.quality-gates.outputs.quality-score }}/100"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ‰ å‘é€æˆåŠŸé€šçŸ¥
        if: needs.quality-gates.result == 'success' && needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ å‘é€æˆåŠŸé€šçŸ¥..."

          # è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥é€»è¾‘
          echo "æµæ°´çº¿æˆåŠŸå®Œæˆ - é€šçŸ¥å·²å‘é€"

          # ç¤ºä¾‹Slacké€šçŸ¥
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸ‰ LLMChat CI/CD æµæ°´çº¿æˆåŠŸå®Œæˆï¼\nç¯å¢ƒ: ${{ needs.deploy.outputs.url || N/A }}\nè´¨é‡åˆ†æ•°: ${{ needs.quality-gates.outputs.quality-score }}/100\nç‰ˆæœ¬: ${{ needs.setup-and-validate.outputs.version }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}