name: ðŸ”’ å‰ç«¯ç±»åž‹å®‰å…¨æ£€æŸ¥æµç¨‹

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'shared-types/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'shared-types/**'
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œå®Œæ•´æ£€æŸ¥
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      strict_mode:
        description: 'å¯ç”¨ä¸¥æ ¼æ¨¡å¼æ£€æŸ¥'
        required: false
        default: true
        type: boolean
      performance_test:
        description: 'è¿è¡Œæ€§èƒ½æµ‹è¯•'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: 8

jobs:
  # ç±»åž‹å®‰å…¨é¢„æ£€æŸ¥
  type-safety-precheck:
    name: ðŸ” ç±»åž‹å®‰å…¨é¢„æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: ðŸ“¦ å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“š å®‰è£…ä¾èµ–
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: ðŸ” å¿«é€Ÿç±»åž‹æ£€æŸ¥
        id: quick-typecheck
        working-directory: frontend
        run: |
          echo "::group::å¿«é€ŸTypeScriptç±»åž‹æ£€æŸ¥"

          # å¢žé‡ç±»åž‹æ£€æŸ¥ï¼ˆå¦‚æžœå­˜åœ¨tsbuildinfoï¼‰
          if [ -f ".tsbuildinfo" ]; then
            echo "ðŸ“Š ä½¿ç”¨å¢žé‡ç±»åž‹æ£€æŸ¥..."
            npx tsc --noEmit --incremental --tsBuildInfoFile .tsbuildinfo
          else
            echo "ðŸ“Š è¿è¡Œå®Œæ•´ç±»åž‹æ£€æŸ¥..."
            npx tsc --noEmit
          fi

          TS_EXIT_CODE=$?

          if [ $TS_EXIT_CODE -ne 0 ]; then
            echo "::error::TypeScriptç±»åž‹æ£€æŸ¥å¤±è´¥"
            echo "typecheck_status=failed" >> $GITHUB_OUTPUT
            echo "typecheck_errors=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… TypeScriptç±»åž‹æ£€æŸ¥é€šè¿‡"
            echo "typecheck_status=passed" >> $GITHUB_OUTPUT
            echo "typecheck_errors=false" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"
          exit $TS_EXIT_CODE

      - name: ðŸ·ï¸ ç±»åž‹è¦†ç›–çŽ‡æ£€æŸ¥
        id: type-coverage
        working-directory: frontend
        run: |
          echo "::group::ç±»åž‹è¦†ç›–çŽ‡åˆ†æž"

          # å®‰è£…type-coverageï¼ˆå¦‚æžœæœªå®‰è£…ï¼‰
          if ! pnpm list type-coverage > /dev/null 2>&1; then
            pnpm add -D type-coverage
          fi

          # è¿è¡Œç±»åž‹è¦†ç›–çŽ‡æ£€æŸ¥
          COVERAGE_RESULT=$(pnpm exec type-coverage --strict --detail --at-least 90)
          COVERAGE_EXIT_CODE=$?

          echo "$COVERAGE_RESULT"

          # æå–è¦†ç›–çŽ‡ç™¾åˆ†æ¯”
          COVERAGE_PERCENTAGE=$(echo "$COVERAGE_RESULT" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | sed 's/%//')

          if [ -z "$COVERAGE_PERCENTAGE" ]; then
            COVERAGE_PERCENTAGE="0"
          fi

          echo "type_coverage_percentage=$COVERAGE_PERCENTAGE" >> $GITHUB_OUTPUT

          if [ $COVERAGE_EXIT_CODE -ne 0 ]; then
            echo "::warning::ç±»åž‹è¦†ç›–çŽ‡ä½ŽäºŽ90%"
            echo "type_coverage_status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… ç±»åž‹è¦†ç›–çŽ‡è¾¾æ ‡ (â‰¥90%)"
            echo "type_coverage_status=passed" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

  # å®Œæ•´ç±»åž‹å®‰å…¨æ£€æŸ¥
  type-safety-comprehensive:
    name: ðŸ”¬ å®Œæ•´ç±»åž‹å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: type-safety-precheck
    if: needs.type-safety-precheck.outputs.typecheck_errors != 'true'

    strategy:
      matrix:
        environment: [development, staging, production]

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: ðŸ“¦ å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“š å®‰è£…ä¾èµ–
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: ðŸ”§ çŽ¯å¢ƒé…ç½®
        run: |
          echo "::group::é…ç½®${{ matrix.environment }}çŽ¯å¢ƒ"

          # åˆ›å»ºçŽ¯å¢ƒç‰¹å®šé…ç½®
          cp .env.example .env.${{ matrix.environment }}

          # æ ¹æ®çŽ¯å¢ƒè®¾ç½®ä¸åŒçš„TypeScripté…ç½®
          if [ "${{ matrix.environment }}" = "production" ]; then
            echo "NODE_ENV=production" >> .env.${{ matrix.environment }}
            echo "TSCONFIG_STRICNESS=true" >> .env.${{ matrix.environment }}
          elif [ "${{ matrix.environment }}" = "staging" ]; then
            echo "NODE_ENV=staging" >> .env.${{ matrix.environment }}
            echo "TSCONFIG_STRICTNESS=true" >> .env.${{ matrix.environment }}
          else
            echo "NODE_ENV=development" >> .env.${{ matrix.environment }}
            echo "TSCONFIG_STRICTNESS=false" >> .env.${{ matrix.environment }}
          fi

          echo "::endgroup::"

      - name: ðŸ—ï¸ æž„å»ºæ£€æŸ¥
        id: build-check
        working-directory: frontend
        run: |
          echo "::group::${{ matrix.environment }}çŽ¯å¢ƒæž„å»ºæ£€æŸ¥"

          # æ ¹æ®çŽ¯å¢ƒä½¿ç”¨ä¸åŒçš„æž„å»ºé…ç½®
          if [ "${{ matrix.environment }}" = "production" ]; then
            pnpm run build
          else
            pnpm run build
          fi

          BUILD_EXIT_CODE=$?

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "::error::${{ matrix.environment }}çŽ¯å¢ƒæž„å»ºå¤±è´¥"
            echo "build_status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… ${{ matrix.environment }}çŽ¯å¢ƒæž„å»ºæˆåŠŸ"
            echo "build_status=passed" >> $GITHUB_OUTPUT

            # æ£€æŸ¥æž„å»ºäº§ç‰©å¤§å°
            BUILD_SIZE=$(du -sh dist | cut -f1)
            echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"
          exit $BUILD_EXIT_CODE

      - name: ðŸ” ä¸¥æ ¼æ¨¡å¼ç±»åž‹æ£€æŸ¥
        id: strict-typecheck
        working-directory: frontend
        run: |
          echo "::group::ä¸¥æ ¼æ¨¡å¼TypeScriptæ£€æŸ¥"

          # ä½¿ç”¨æ›´ä¸¥æ ¼çš„TypeScripté…ç½®
          npx tsc --noEmit --strict --exactOptionalPropertyTypes --noUncheckedIndexedAccess

          TS_EXIT_CODE=$?

          if [ $TS_EXIT_CODE -ne 0 ]; then
            echo "::error::ä¸¥æ ¼æ¨¡å¼ç±»åž‹æ£€æŸ¥å¤±è´¥"
            echo "strict_typecheck_status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… ä¸¥æ ¼æ¨¡å¼ç±»åž‹æ£€æŸ¥é€šè¿‡"
            echo "strict_typecheck_status=passed" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"
          exit $TS_EXIT_CODE

      - name: ðŸ§ª ESLintç±»åž‹è§„åˆ™æ£€æŸ¥
        id: eslint-typecheck
        working-directory: frontend
        run: |
          echo "::group::ESLintç±»åž‹è§„åˆ™æ£€æŸ¥"

          # è¿è¡Œä¸“é—¨çš„ç±»åž‹ç›¸å…³ESLintè§„åˆ™
          npx eslint src --ext .ts,.tsx \
            --config .eslintrc.cjs \
            --rule '@typescript-eslint/no-explicit-any:error' \
            --rule '@typescript-eslint/no-unsafe-assignment:error' \
            --rule '@typescript-eslint/no-unsafe-call:error' \
            --rule '@typescript-eslint/no-unsafe-member-access:error' \
            --rule '@typescript-eslint/no-unsafe-return:error' \
            --rule '@typescript-eslint/prefer-nullish-coalescing:error' \
            --rule '@typescript-eslint/prefer-optional-chain:error' \
            --format json > eslint-type-report.json

          ESLINT_EXIT_CODE=$?

          # ç»Ÿè®¡é”™è¯¯æ•°é‡
          TYPE_ERRORS=$(cat eslint-type-report.json | jq '[.[] | select(.severity == 2)] | length')
          TYPE_WARNINGS=$(cat eslint-type-report.json | jq '[.[] | select(.severity == 1)] | length')

          echo "eslint_type_errors=$TYPE_ERRORS" >> $GITHUB_OUTPUT
          echo "eslint_type_warnings=$TYPE_WARNINGS" >> $GITHUB_OUTPUT

          if [ $ESLINT_EXIT_CODE -ne 0 ]; then
            echo "::error::ESLintç±»åž‹è§„åˆ™æ£€æŸ¥å¤±è´¥"
            echo "eslint_typecheck_status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… ESLintç±»åž‹è§„åˆ™æ£€æŸ¥é€šè¿‡"
            echo "eslint_typecheck_status=passed" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"
          exit $ESLINT_EXIT_CODE

      - name: ðŸ”„ ç±»åž‹å›žå½’æµ‹è¯•
        id: type-regression
        working-directory: frontend
        run: |
          echo "::group::ç±»åž‹å›žå½’æµ‹è¯•"

          # æ£€æŸ¥æ˜¯å¦æœ‰ç±»åž‹å®šä¹‰çš„ç ´åæ€§å˜æ›´
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # å¯¹æ¯”ä¸»åˆ†æ”¯ï¼Œæ£€æŸ¥ç±»åž‹é”™è¯¯æ•°é‡å˜åŒ–
            git fetch origin main
            MAIN_BRANCH_HASH=$(git rev-parse origin/main)
            CURRENT_BRANCH_HASH=$(git rev-parse HEAD)

            echo "ðŸ” æ£€æŸ¥ç›¸å¯¹äºŽmainåˆ†æ”¯çš„ç±»åž‹å˜æ›´..."

            # åˆ›å»ºåŸºçº¿ç±»åž‹æŠ¥å‘Š
            git checkout $MAIN_BRANCH_HASH
            npx tsc --noEmit --pretty false 2> ../baseline-type-errors.txt || true
            BASELINE_ERRORS=$(cat ../baseline-type-errors.txt | grep -c "error TS" || echo "0")

            # æ£€æŸ¥å½“å‰åˆ†æ”¯çš„ç±»åž‹é”™è¯¯
            git checkout $CURRENT_BRANCH_HASH
            npx tsc --noEmit --pretty false 2> ../current-type-errors.txt || true
            CURRENT_ERRORS=$(cat ../current-type-errors.txt | grep -c "error TS" || echo "0")

            # è®¡ç®—è¯¯å·®å˜åŒ–
            ERROR_DIFF=$((CURRENT_ERRORS - BASELINE_ERRORS))

            echo "baseline_errors=$BASELINE_ERRORS" >> $GITHUB_OUTPUT
            echo "current_errors=$CURRENT_ERRORS" >> $GITHUB_OUTPUT
            echo "error_diff=$ERROR_DIFF" >> $GITHUB_OUTPUT

            if [ $ERROR_DIFF -gt 0 ]; then
              echo "::error::æ£€æµ‹åˆ°ç±»åž‹é”™è¯¯å›žå½’ (+$ERROR_DIFF)"
              echo "type_regression_status=failed" >> $GITHUB_OUTPUT
            else
              echo "âœ… æœªæ£€æµ‹åˆ°ç±»åž‹é”™è¯¯å›žå½’"
              echo "type_regression_status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ éžPRè¯·æ±‚ï¼Œè·³è¿‡ç±»åž‹å›žå½’æµ‹è¯•"
            echo "type_regression_status=skipped" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

  # æ€§èƒ½å½±å“è¯„ä¼°
  type-safety-performance:
    name: âš¡ ç±»åž‹å®‰å…¨æ€§èƒ½å½±å“è¯„ä¼°
    runs-on: ubuntu-latest
    needs: type-safety-comprehensive
    if: |
      always() &&
      needs.type-safety-comprehensive.result == 'success' &&
      (github.event.inputs.performance_test == 'true' || github.event_name == 'schedule')

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: ðŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•
        id: performance-benchmark
        working-directory: frontend
        run: |
          echo "::group::ç±»åž‹å®‰å…¨æ€§èƒ½åŸºå‡†æµ‹è¯•"

          # TypeScriptç¼–è¯‘æ€§èƒ½æµ‹è¯•
          echo "ðŸ“Š TypeScriptç¼–è¯‘æ€§èƒ½æµ‹è¯•..."
          TS_COMPILE_TIME=$(time (npx tsc --noEmit) 2>&1 | grep real | awk '{print $2}')
          echo "ts_compile_time=$TS_COMPILE_TIME" >> $GITHUB_OUTPUT

          # ESLintæ£€æŸ¥æ€§èƒ½æµ‹è¯•
          echo "ðŸ“Š ESLintæ£€æŸ¥æ€§èƒ½æµ‹è¯•..."
          ESLINT_TIME=$(time (npx eslint src --ext .ts,.tsx) 2>&1 | grep real | awk '{print $2}')
          echo "eslint_check_time=$ESLINT_TIME" >> $GITHUB_OUTPUT

          # æž„å»ºæ€§èƒ½æµ‹è¯•
          echo "ðŸ“Š æž„å»ºæ€§èƒ½æµ‹è¯•..."
          BUILD_TIME=$(time (pnpm run build) 2>&1 | grep real | awk '{print $2}')
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

          # å†…å­˜ä½¿ç”¨ç›‘æŽ§
          echo "ðŸ“Š å†…å­˜ä½¿ç”¨ç›‘æŽ§..."
          MEMORY_USAGE=$(ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem -C node | head -2 | tail -1 | awk '{print $4}')
          echo "memory_usage=$MEMORY_USAGE" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: ðŸ“ˆ æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ
        run: |
          echo "::group::ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"

          cat > performance-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ matrix.environment || 'default' }}",
            "performance": {
              "typescript": {
                "compile_time": "${{ steps.performance-benchmark.outputs.ts_compile_time }}"
              },
              "eslint": {
                "check_time": "${{ steps.performance-benchmark.outputs.eslint_check_time }}"
              },
              "build": {
                "time": "${{ steps.performance-benchmark.outputs.build_time }}"
              },
              "memory": {
                "usage": "${{ steps.performance-benchmark.outputs.memory_usage }}%"
              }
            }
          }
          EOF

          echo "::endgroup::"

      - name: ðŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: type-safety-performance-report-${{ github.sha }}
          path: performance-report.json
          retention-days: 30

  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    name: ðŸšª ç±»åž‹å®‰å…¨è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [type-safety-precheck, type-safety-comprehensive]
    if: always()

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” è´¨é‡é—¨ç¦æ£€æŸ¥
        run: |
          echo "::group::ç±»åž‹å®‰å…¨è´¨é‡é—¨ç¦æ£€æŸ¥"

          # æ£€æŸ¥æ‰€æœ‰å‰ç½®ä½œä¸šçŠ¶æ€
          TYPECHECK_STATUS="${{ needs.type-safety-precheck.result }}"
          COMPREHENSIVE_STATUS="${{ needs.type-safety-comprehensive.result }}"

          echo "ðŸ“Š ä½œä¸šçŠ¶æ€æ£€æŸ¥:"
          echo "- ç±»åž‹é¢„æ£€æŸ¥: $TYPECHECK_STATUS"
          echo "- å®Œæ•´ç±»åž‹æ£€æŸ¥: $COMPREHENSIVE_STATUS"

          # è´¨é‡é—¨ç¦è§„åˆ™
          GATE_PASSED=true

          if [ "$TYPECHECK_STATUS" != "success" ]; then
            echo "::error::âŒ ç±»åž‹é¢„æ£€æŸ¥å¤±è´¥ï¼Œé˜»æ­¢åˆå¹¶"
            GATE_PASSED=false
          fi

          if [ "$COMPREHENSIVE_STATUS" != "success" ]; then
            echo "::error::âŒ å®Œæ•´ç±»åž‹æ£€æŸ¥å¤±è´¥ï¼Œé˜»æ­¢åˆå¹¶"
            GATE_PASSED=false
          fi

          if [ "$GATE_PASSED" = "true" ]; then
            echo "âœ… ðŸŽ‰ ç±»åž‹å®‰å…¨è´¨é‡é—¨ç¦é€šè¿‡ï¼"
            echo "quality_gate_status=passed" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "::error::ðŸš« ç±»åž‹å®‰å…¨è´¨é‡é—¨ç¦å¤±è´¥ï¼Œè¯·ä¿®å¤ç±»åž‹é—®é¢˜åŽé‡è¯•"
            echo "quality_gate_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "::endgroup::"

  # æŠ¥å‘Šç”Ÿæˆå’Œé€šçŸ¥
  type-safety-report:
    name: ðŸ“‹ ç±»åž‹å®‰å…¨æŠ¥å‘Šç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [type-safety-precheck, type-safety-comprehensive, quality-gate]
    if: always()

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        id: generate-report
        run: |
          echo "::group::ç”Ÿæˆç±»åž‹å®‰å…¨ç»¼åˆæŠ¥å‘Š"

          # åˆ›å»ºç»¼åˆæŠ¥å‘Š
          cat > type-safety-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "event": "${{ github.event_name }}",
            "quality_gate": {
              "status": "${{ needs.quality-gate.result }}",
              "passed": "${{ needs.quality-gate.result == 'success' }}"
            },
            "checks": {
              "precheck": {
                "status": "${{ needs.type-safety-precheck.result }}",
                "typecheck": "${{ needs.type-safety-precheck.outputs.typecheck_status }}",
                "type_coverage": "${{ needs.type-safety-precheck.outputs.type_coverage_percentage }}%"
              },
              "comprehensive": {
                "status": "${{ needs.type-safety-comprehensive.result }}",
                "build": "${{ needs.type-safety-comprehensive.outputs.build_status }}",
                "strict_typecheck": "${{ needs.type-safety-comprehensive.outputs.strict_typecheck_status }}",
                "eslint_typecheck": "${{ needs.type-safety-comprehensive.outputs.eslint_typecheck_status }}",
                "type_regression": "${{ needs.type-safety-comprehensive.outputs.type_regression_status }}"
              }
            },
            "metrics": {
              "type_errors": "${{ needs.type-safety-comprehensive.outputs.eslint_type_errors || 0 }}",
              "type_warnings": "${{ needs.type-safety-comprehensive.outputs.eslint_type_warnings || 0 }}",
              "build_size": "${{ needs.type-safety-comprehensive.outputs.build_size || 'unknown' }}"
            }
          }
          EOF

          echo "âœ… ç±»åž‹å®‰å…¨ç»¼åˆæŠ¥å‘Šç”Ÿæˆå®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ“¤ ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: type-safety-report-${{ github.sha }}
          path: type-safety-report.json
          retention-days: 30

      - name: ðŸ’¬ PRè¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('type-safety-report.json', 'utf8'));

            const statusEmoji = report.quality_gate.passed ? 'âœ…' : 'âŒ';
            const statusText = report.quality_gate.passed ? 'é€šè¿‡' : 'å¤±è´¥';

            const body = `
            ## ðŸ”’ ç±»åž‹å®‰å…¨æ£€æŸ¥æŠ¥å‘Š

            **è´¨é‡é—¨ç¦çŠ¶æ€**: ${statusEmoji} ${statusText}

            ### ðŸ“Š æ£€æŸ¥ç»“æžœ

            | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
            |--------|------|------|
            | TypeScriptç±»åž‹æ£€æŸ¥ | ${report.checks.precheck.typecheck === 'passed' ? 'âœ…' : 'âŒ'} | é›¶é”™è¯¯ç­–ç•¥ |
            | ç±»åž‹è¦†ç›–çŽ‡ | ${report.checks.precheck.type_coverage} | ç›®æ ‡: â‰¥90% |
            | ä¸¥æ ¼æ¨¡å¼æ£€æŸ¥ | ${report.checks.comprehensive.strict_typecheck === 'passed' ? 'âœ…' : 'âŒ'} | ä¸¥æ ¼ç±»åž‹æ£€æŸ¥ |
            | ESLintç±»åž‹è§„åˆ™ | ${report.checks.comprehensive.eslint_typecheck === 'passed' ? 'âœ…' : 'âŒ'} | ${report.metrics.type_errors} é”™è¯¯, ${report.metrics.type_warnings} è­¦å‘Š |
            | æž„å»ºæ£€æŸ¥ | ${report.checks.comprehensive.build === 'passed' ? 'âœ…' : 'âŒ'} | æž„å»ºå¤§å°: ${report.metrics.build_size} |
            | ç±»åž‹å›žå½’æµ‹è¯• | ${report.checks.comprehensive.type_regression === 'passed' ? 'âœ…' : report.checks.comprehensive.type_regression === 'skipped' ? 'â­ï¸' : 'âŒ'} | é˜²æ­¢ç±»åž‹é€€åŒ– |

            ${report.quality_gate.passed ?
              'ðŸŽ‰ **ç±»åž‹å®‰å…¨æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼** ä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥å®‰å…¨åˆå¹¶ã€‚' :
              'ðŸš« **ç±»åž‹å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼** è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åŽé‡æ–°æäº¤æ£€æŸ¥ã€‚'
            }

            ---
            *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date(report.timestamp).toLocaleString('zh-CN')}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ðŸ“§ é€šçŸ¥
        if: failure() && github.event_name != 'pull_request'
        run: |
          echo "::group::å‘é€å¤±è´¥é€šçŸ¥"
          echo "ç±»åž‹å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CI/CDæ—¥å¿—"
          echo "è¿™é‡Œå¯ä»¥é›†æˆSlackã€é’‰é’‰ç­‰é€šçŸ¥ç³»ç»Ÿ"
          echo "::endgroup::"

  # ç±»åž‹å®‰å…¨ç›‘æŽ§ä»ªè¡¨æ¿æ›´æ–°
  update-dashboard:
    name: ðŸ“ˆ æ›´æ–°ç±»åž‹å®‰å…¨ç›‘æŽ§ä»ªè¡¨æ¿
    runs-on: ubuntu-latest
    needs: [type-safety-precheck, type-safety-comprehensive, quality-gate]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“Š æ›´æ–°ç›‘æŽ§æ•°æ®
        run: |
          echo "::group::æ›´æ–°ç±»åž‹å®‰å…¨ç›‘æŽ§æ•°æ®"

          # è¿™é‡Œå¯ä»¥é›†æˆåˆ°ç›‘æŽ§ç³»ç»Ÿ
          echo "æ›´æ–°ç±»åž‹å®‰å…¨ç›‘æŽ§æŒ‡æ ‡..."
          echo "- ç±»åž‹é”™è¯¯æ•°é‡: ${{ needs.type-safety-comprehensive.outputs.eslint_type_errors || 0 }}"
          echo "- ç±»åž‹è¦†ç›–çŽ‡: ${{ needs.type-safety-precheck.outputs.type_coverage_percentage }}%"
          echo "- è´¨é‡é—¨ç¦çŠ¶æ€: ${{ needs.quality-gate.result }}"

          # å¯ä»¥å‘é€åˆ°Prometheusã€Grafanaç­‰ç›‘æŽ§ç³»ç»Ÿ
          echo "::endgroup::"