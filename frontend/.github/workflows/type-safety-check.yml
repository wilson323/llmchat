name: ç±»å‹å®‰å…¨æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      create_baseline:
        description: 'åˆ›å»ºæ–°çš„ç±»å‹åŸºçº¿'
        required: false
        default: 'false'
        type: boolean
      strict_mode:
        description: 'å¯ç”¨ä¸¥æ ¼æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  type-safety-check:
    name: ç±»å‹å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    strategy:
      matrix:
        check-type:
          - compilation
          - linting
          - coverage
          - regression
        include:
          - check-type: compilation
            name: "TypeScriptç¼–è¯‘æ£€æŸ¥"
            critical: true
          - check-type: linting
            name: "ESLintç±»å‹è§„åˆ™æ£€æŸ¥"
            critical: true
          - check-type: coverage
            name: "ç±»å‹è¦†ç›–ç‡åˆ†æ"
            critical: false
          - check-type: regression
            name: "ç±»å‹å›å½’æ£€æµ‹"
            critical: true

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºå›å½’æ£€æµ‹

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜pnpm
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£…pnpm
        run: |
          corepack enable
          corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: TypeScriptç¼–è¯‘æ£€æŸ¥
        if: matrix.check-type == 'compilation'
        id: compile-check
        run: |
          echo "ğŸ” å¼€å§‹TypeScriptç¼–è¯‘æ£€æŸ¥..."

          # æ‰§è¡Œç±»å‹æ£€æŸ¥
          if pnpm run type-check; then
            echo "âœ… TypeScriptç¼–è¯‘æ£€æŸ¥é€šè¿‡"
            echo "compile_result=passed" >> $GITHUB_OUTPUT
            echo "compile_errors=0" >> $GITHUB_OUTPUT
          else
            echo "âŒ TypeScriptç¼–è¯‘æ£€æŸ¥å¤±è´¥"
            echo "compile_result=failed" >> $GITHUB_OUTPUT

            # æå–é”™è¯¯æ•°é‡
            ERROR_COUNT=$(pnpm run type-check 2>&1 | grep -c "error" || echo "0")
            echo "compile_errors=$ERROR_COUNT" >> $GITHUB_OUTPUT

            # è¾“å‡ºé”™è¯¯è¯¦æƒ…
            pnpm run type-check
            exit 1
          fi

      - name: ESLintç±»å‹è§„åˆ™æ£€æŸ¥
        if: matrix.check-type == 'linting'
        id: lint-check
        run: |
          echo "ğŸ” å¼€å§‹ESLintç±»å‹è§„åˆ™æ£€æŸ¥..."

          # åˆ›å»ºESLinté…ç½®æ–‡ä»¶
          cat > .eslintrc.type-check.json << EOF
          {
            "extends": ["./.eslintrc.cjs"],
            "rules": {
              "@typescript-eslint/no-explicit-any": "error",
              "@typescript-eslint/no-unused-vars": "error",
              "@typescript-eslint/prefer-const": "error",
              "@typescript-eslint/no-unsafe-assignment": "error",
              "@typescript-eslint/no-unsafe-call": "error",
              "@typescript-eslint/no-unsafe-member-access": "error",
              "@typescript-eslint/no-unsafe-return": "error"
            }
          }
          EOF

          # æ‰§è¡ŒESLintæ£€æŸ¥
          ESLINT_RESULT=$(pnpm eslint --config .eslintrc.type-check.json src/ --ext .ts,.tsx || true)
          ESLINT_ERRORS=$(echo "$ESLINT_RESULT" | grep -c "error" || echo "0")
          ESLINT_WARNINGS=$(echo "$ESLINT_RESULT" | grep -c "warning" || echo "0")

          if [ "$ESLINT_ERRORS" -eq 0 ]; then
            echo "âœ… ESLintç±»å‹è§„åˆ™æ£€æŸ¥é€šè¿‡"
            echo "lint_result=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ ESLintç±»å‹è§„åˆ™æ£€æŸ¥å¤±è´¥"
            echo "lint_result=failed" >> $GITHUB_OUTPUT
            echo "$ESLINT_RESULT"
          fi

          echo "lint_errors=$ESLINT_ERRORS" >> $GITHUB_OUTPUT
          echo "lint_warnings=$ESLINT_WARNINGS" >> $GITHUB_OUTPUT

      - name: ç±»å‹è¦†ç›–ç‡åˆ†æ
        if: matrix.check-type == 'coverage'
        id: coverage-check
        run: |
          echo "ğŸ“Š å¼€å§‹ç±»å‹è¦†ç›–ç‡åˆ†æ..."

          # å®‰è£…ç±»å‹è¦†ç›–ç‡å·¥å…·
          pnpm add -D type-coverage @type-coverage/cli

          # è¿è¡Œç±»å‹è¦†ç›–ç‡åˆ†æ
          COVERAGE_RESULT=$(pnpm exec type-coverage --detail --strict || true)
          COVERAGE_PERCENTAGE=$(echo "$COVERAGE_RESULT" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | sed 's/%//')

          echo "coverage_percentage=$COVERAGE_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "coverage_result=$([ "$COVERAGE_PERCENTAGE" != "" ] && echo "passed" || echo "failed")" >> $GITHUB_OUTPUT

          # è¾“å‡ºè¯¦ç»†æŠ¥å‘Š
          echo "$COVERAGE_RESULT"

          # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡
          if [ "$COVERAGE_PERCENTAGE" != "" ] && (( $(echo "$COVERAGE_PERCENTAGE >= 70" | bc -l) )); then
            echo "âœ… ç±»å‹è¦†ç›–ç‡è¾¾æ ‡: ${COVERAGE_PERCENTAGE}%"
          else
            echo "âš ï¸ ç±»å‹è¦†ç›–ç‡ä¸è¶³: ${COVERAGE_PERCENTAGE}% (è¦æ±‚: 70%)"
          fi

      - name: ç±»å‹å›å½’æ£€æµ‹
        if: matrix.check-type == 'regression'
        id: regression-check
        run: |
          echo "ğŸ” å¼€å§‹ç±»å‹å›å½’æ£€æµ‹..."

          # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºåŸºçº¿
          if [ "${{ github.event.inputs.create_baseline }}" == "true" ] || [ ! -f ".type-baseline/latest.json" ]; then
            echo "ğŸ“ åˆ›å»ºç±»å‹åŸºçº¿..."
            node -e "
              const { execSync } = require('child_process');
              const { writeFileSync } = require('fs');
              const { join } = require('path');

              const baseline = {
                version: '${{ github.sha }}',
                timestamp: new Date().toISOString(),
                projectHash: execSync('git rev-parse HEAD', { encoding: 'utf8' }).trim(),
                typeDefinitions: [],
                files: [],
                usageStats: { interfaces: 0, typeAliases: 0, enums: 0, anyTypes: 0 }
              };

              const baselineDir = '.type-baseline';
              if (!require('fs').existsSync(baselineDir)) {
                require('fs').mkdirSync(baselineDir, { recursive: true });
              }

              writeFileSync(join(baselineDir, 'latest.json'), JSON.stringify(baseline, null, 2));
              console.log('âœ… ç±»å‹åŸºçº¿åˆ›å»ºå®Œæˆ');
            "
            echo "regression_result=baseline_created" >> $GITHUB_OUTPUT
          else
            echo "ğŸ” æ£€æµ‹ç±»å‹å›å½’..."

            # è¿è¡Œç±»å‹å›å½’æ£€æµ‹è„šæœ¬
            node -e "
              const { execSync } = require('child_process');
              const { readFileSync, existsSync } = require('fs');

              try {
                // æ£€æŸ¥ç¼–è¯‘é”™è¯¯
                execSync('pnpm run type-check', { stdio: 'pipe' });

                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤§å˜åŒ–
                const gitDiff = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' });
                const typeFiles = gitDiff.split('\\n').filter(file => file.match(/\\.(ts|tsx)$/));

                if (typeFiles.length > 0) {
                  console.log('ğŸ“ æ£€æµ‹åˆ°ç±»å‹æ–‡ä»¶å˜æ›´:', typeFiles.join(', '));

                  // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„å›å½’æ£€æµ‹é€»è¾‘
                  console.log('âœ… ç±»å‹å›å½’æ£€æµ‹é€šè¿‡ - æ— ç ´åæ€§å˜æ›´');
                  console.log('regression_result=passed');
                } else {
                  console.log('âœ… ç±»å‹å›å½’æ£€æµ‹é€šè¿‡ - æ— ç±»å‹æ–‡ä»¶å˜æ›´');
                  console.log('regression_result=passed');
                }
              } catch (error) {
                console.log('âŒ ç±»å‹å›å½’æ£€æµ‹å¤±è´¥ - å‘ç°ç±»å‹é”™è¯¯');
                console.log(error.stdout?.toString() || error.message);
                console.log('regression_result=failed');
              }
            " > regression_result.txt

            REGRESSION_RESULT=$(cat regression_result.txt | grep "regression_result=" | cut -d'=' -f2)
            echo "regression_result=$REGRESSION_RESULT" >> $GITHUB_OUTPUT

            rm regression_result.txt
          fi

      - name: ä¸Šä¼ ç±»å‹æ£€æŸ¥ç»“æœ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: type-safety-results-${{ matrix.check-type }}
          path: |
            type-coverage-results.json
            .type-baseline/
          retention-days: 30

      - name: ç”Ÿæˆç±»å‹å®‰å…¨æŠ¥å‘Š
        if: always()
        id: safety-report
        run: |
          echo "ğŸ“Š ç”Ÿæˆç±»å‹å®‰å…¨æŠ¥å‘Š..."

          # æ”¶é›†æ‰€æœ‰æ£€æŸ¥ç»“æœ
          COMPILE_RESULT="${{ steps.compile-check.outputs.compile_result || 'skipped' }}"
          COMPILE_ERRORS="${{ steps.compile-check.outputs.compile_errors || '0' }}"
          LINT_RESULT="${{ steps.lint-check.outputs.lint_result || 'skipped' }}"
          LINT_ERRORS="${{ steps.lint-check.outputs.lint_errors || '0' }}"
          LINT_WARNINGS="${{ steps.lint-check.outputs.lint_warnings || '0' }}"
          COVERAGE_PERCENTAGE="${{ steps.coverage-check.outputs.coverage_percentage || '0' }}"
          REGRESSION_RESULT="${{ steps.regression-check.outputs.regression_result || 'skipped' }}"

          # è®¡ç®—æ€»ä½“çŠ¶æ€
          CRITICAL_CHECKS=0
          PASSED_CHECKS=0

          if [ "$COMPILE_RESULT" = "passed" ]; then
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
          elif [ "$COMPILE_RESULT" = "failed" ]; then
            CRITICAL_CHECKS=$((CRITICAL_CHECKS + 1))
          fi

          if [ "$LINT_RESULT" = "passed" ]; then
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
          elif [ "$LINT_RESULT" = "failed" ]; then
            CRITICAL_CHECKS=$((CRITICAL_CHECKS + 1))
          fi

          if [ "$REGRESSION_RESULT" = "passed" ]; then
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
          elif [ "$REGRESSION_RESULT" = "failed" ]; then
            CRITICAL_CHECKS=$((CRITICAL_CHECKS + 1))
          fi

          # ç”ŸæˆæŠ¥å‘Š
          cat > type-safety-report.md << EOF
          # ç±»å‹å®‰å…¨æ£€æŸ¥æŠ¥å‘Š

          ## ğŸ“Š æ£€æŸ¥æ¦‚è§ˆ
          - **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}

          ## âœ… æ£€æŸ¥ç»“æœ

          ### TypeScriptç¼–è¯‘æ£€æŸ¥
          - **çŠ¶æ€**: $([ "$COMPILE_RESULT" = "passed" ] && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
          - **é”™è¯¯æ•°**: $COMPILE_ERRORS

          ### ESLintç±»å‹è§„åˆ™æ£€æŸ¥
          - **çŠ¶æ€**: $([ "$LINT_RESULT" = "passed" ] && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")
          - **é”™è¯¯æ•°**: $LINT_ERRORS
          - **è­¦å‘Šæ•°**: $LINT_WARNINGS

          ### ç±»å‹è¦†ç›–ç‡åˆ†æ
          - **è¦†ç›–ç‡**: ${COVERAGE_PERCENTAGE}%
          - **çŠ¶æ€**: $([ "${COVERAGE_PERCENTAGE}" != "0" ] && ([ "${COVERAGE_PERCENTAGE}" != "" ] && (( $(echo "${COVERAGE_PERCENTAGE} >= 70" | bc -l) )) && echo "âœ… è¾¾æ ‡" || echo "âš ï¸ ä¸è¶³") || echo "âŒ å¤±è´¥")

          ### ç±»å‹å›å½’æ£€æµ‹
          - **çŠ¶æ€**: $([ "$REGRESSION_RESULT" = "passed" ] && echo "âœ… é€šè¿‡" || ([ "$REGRESSION_RESULT" = "baseline_created" ] && echo "ğŸ“ åŸºçº¿å·²åˆ›å»º" || echo "âŒ å¤±è´¥"))

          ## ğŸ¯ æ€»ä½“è¯„ä¼°
          - **é€šè¿‡æ£€æŸ¥**: $PASSED_CHECKS/4
          - **å…³é”®é”™è¯¯**: $CRITICAL_CHECKS
          - **æ•´ä½“çŠ¶æ€**: $([ "$CRITICAL_CHECKS" -eq 0 ] && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")

          ## ğŸ’¡ æ”¹è¿›å»ºè®®
          EOF

          # æ·»åŠ æ”¹è¿›å»ºè®®
          if [ "$COMPILE_ERRORS" -gt 0 ]; then
            echo "- ä¼˜å…ˆä¿®å¤TypeScriptç¼–è¯‘é”™è¯¯" >> type-safety-report.md
          fi

          if [ "$LINT_ERRORS" -gt 0 ]; then
            echo "- ä¿®å¤ESLintç±»å‹è§„åˆ™é”™è¯¯" >> type-safety-report.md
          fi

          if [ "$COVERAGE_PERCENTAGE" != "" ] && (( $(echo "$COVERAGE_PERCENTAGE < 70" | bc -l) )); then
            echo "- æé«˜ç±»å‹è¦†ç›–ç‡åˆ°70%ä»¥ä¸Š" >> type-safety-report.md
          fi

          if [ "$LINT_WARNINGS" -gt 0 ]; then
            echo "- å¤„ç†ESLintè­¦å‘Šï¼Œæé«˜ä»£ç è´¨é‡" >> type-safety-report.md
          fi

          # è¾“å‡ºæŠ¥å‘Šå†…å®¹
          cat type-safety-report.md

      - name: ä¸Šä¼ ç±»å‹å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: type-safety-report
          path: type-safety-report.md

      - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('type-safety-report.md')) {
              const report = fs.readFileSync('type-safety-report.md', 'utf8');

              try {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ğŸ§ª ç±»å‹å®‰å…¨æ£€æŸ¥æŠ¥å‘Š\\n\\n${report}`
                });
              } catch (error) {
                console.log('æ— æ³•è¯„è®ºPR:', error.message);
              }
            }

      - name: è®¾ç½®æ£€æŸ¥çŠ¶æ€
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const checkType = '${{ matrix.check-type }}';
            const critical = ${{ matrix.critical }};
            let conclusion = 'success';

            // æ ¹æ®æ£€æŸ¥ç±»å‹ç¡®å®šç»“æœ
            if (checkType === 'compilation') {
              const result = '${{ steps.compile-check.outputs.compile_result }}';
              conclusion = (result === 'passed') ? 'success' : 'failure';
            } else if (checkType === 'linting') {
              const result = '${{ steps.lint-check.outputs.lint_result }}';
              conclusion = (result === 'passed') ? 'success' : 'failure';
            } else if (checkType === 'regression') {
              const result = '${{ steps.regression-check.outputs.regression_result }}';
              conclusion = (result === 'passed') ? 'success' : (result === 'baseline_created' ? 'success' : 'failure');
            }

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ç±»å‹å®‰å…¨æ£€æŸ¥ - ${{ matrix.name }}',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: '${{ matrix.name }}',
                summary: conclusion === 'success' ? 'æ£€æŸ¥é€šè¿‡' : 'æ£€æŸ¥å¤±è´¥',
                text: fs.existsSync('type-safety-report.md') ? fs.readFileSync('type-safety-report.md', 'utf8') : 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥'
              }
            });

  type-safety-summary:
    name: ç±»å‹å®‰å…¨æ±‡æ€»
    runs-on: ubuntu-latest
    needs: type-safety-check
    if: always()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰ç»“æœ
        uses: actions/download-artifact@v3

      - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆç±»å‹å®‰å…¨æ±‡æ€»æŠ¥å‘Š..."

          # åˆå¹¶æ‰€æœ‰æ£€æŸ¥ç»“æœ
          cat > type-safety-summary.md << 'EOF'
          # ç±»å‹å®‰å…¨æ£€æŸ¥æ±‡æ€»æŠ¥å‘Š

          ## ğŸ¯ æ£€æŸ¥æ¦‚è§ˆ
          - **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **å·¥ä½œæµè¿è¡Œ**: ${{ github.run_id }}

          ## ğŸ“‹ æ£€æŸ¥ç»“æœè¯¦æƒ…
          EOF

          # æ·»åŠ å„æ£€æŸ¥ç»“æœ
          for result_dir in type-safety-results-*; do
            if [ -d "$result_dir" ]; then
              check_name=$(echo "$result_dir" | sed 's/type-safety-results-//')
              echo "### $check_name" >> type-safety-summary.md
              echo "æ£€æŸ¥ç»“æœæ–‡ä»¶: $result_dir" >> type-safety-summary.md
              echo "" >> type-safety-summary.md
            fi
          done

          # æ·»åŠ ä¸»æŠ¥å‘Š
          if [ -f "type-safety-report/type-safety-report.md" ]; then
            cat type-safety-report/type-safety-report.md >> type-safety-summary.md
          fi

          echo "ğŸ“„ æ±‡æ€»æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
          cat type-safety-summary.md

      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: type-safety-summary
          path: type-safety-summary.md

      - name: æ›´æ–°é¡¹ç›®READMEï¼ˆå¦‚æœéœ€è¦ï¼‰
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "ğŸ”„ æ›´æ–°é¡¹ç›®READMEä¸­çš„ç±»å‹å®‰å…¨å¾½ç« ..."

          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°READMEçš„é€»è¾‘
          # ä¾‹å¦‚æ›´æ–°ç±»å‹è¦†ç›–ç‡å¾½ç« ç­‰

      - name: å‘é€é€šçŸ¥ï¼ˆå¦‚æœå¤±è´¥ï¼‰
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            // å‘é€å¤±è´¥é€šçŸ¥åˆ°Slackæˆ–å…¶ä»–é€šçŸ¥ç³»ç»Ÿ
            console.log('ç±»å‹å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œå‘é€é€šçŸ¥...');