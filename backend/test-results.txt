
> @llmchat/backend@1.0.0 test
> jest --runInBand

node.exe : FAIL src/__tests__/integration/chat.integration.test.ts (6.765 s)
At F:\ProgramFiles\nodejs\npm.ps1:29 char:3
+   & $NODE_EXE $NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL src/__test...st.ts (6.765 s) 
   :String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  ● Console

    console.warn
      [WARN] Redis server does not require a password, but a password was suppl
ied.

      at ../node_modules/.pnpm/ioredis@5.8.1/node_modules/ioredis/built/redis/e
vent_handler.js:24:33
      at tryCatcher (../node_modules/.pnpm/standard-as-callback@2.1.0/node_modu
les/standard-as-callback/built/utils.js:12:23)
      at ../node_modules/.pnpm/standard-as-callback@2.1.0/node_modules/standard
-as-callback/built/index.js:33:51

    console.warn
      [WARN] Redis server does not require a password, but a password was suppl
ied.

      at ../node_modules/.pnpm/ioredis@5.8.1/node_modules/ioredis/built/redis/e
vent_handler.js:24:33
      at tryCatcher (../node_modules/.pnpm/standard-as-callback@2.1.0/node_modu
les/standard-as-callback/built/utils.js:12:23)
      at ../node_modules/.pnpm/standard-as-callback@2.1.0/node_modules/standard
-as-callback/built/index.js:33:51

    console.warn
      [WARN] Redis server does not require a password, but a password was suppl
ied.

      at ../node_modules/.pnpm/ioredis@5.8.1/node_modules/ioredis/built/redis/e
vent_handler.js:24:33
      at tryCatcher (../node_modules/.pnpm/standard-as-callback@2.1.0/node_modu
les/standard-as-callback/built/utils.js:12:23)
      at ../node_modules/.pnpm/standard-as-callback@2.1.0/node_modules/standard
-as-callback/built/index.js:33:51

  ● Chat Integration Tests › Complete Chat Flow › should create session and sen
d messages

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:45:27)

  ● Chat Integration Tests › Complete Chat Flow › should handle streaming respo
nses

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:102:27)

  ● Chat Integration Tests › Multiple Sessions Management › should handle multi
ple concurrent sessions

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:141:27)

  ● Chat Integration Tests › Multiple Sessions Management › should isolate mess
ages between sessions

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:172:27)

  ● Chat Integration Tests › Message Persistence › should persist messages acro
ss requests

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:210:27)

  ● Chat Integration Tests › Message Persistence › should maintain message orde
r

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:242:27)

  ● Chat Integration Tests › Agent Switching › should switch agent mid-conversa
tion

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:275:27)

  ● Chat Integration Tests › Performance › should handle rapid message sending

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:313:27)

  ● Chat Integration Tests › Error Scenarios › should handle unauthorized sessi
on access

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:345:27)

  ● Chat Integration Tests › Error Scenarios › should handle malformed message 
content

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:380:27)


  ● Test suite failed to run

    DB_NOT_INITIALIZED

    [0m [90m 108 |[39m [36mexport[39m [36mfunction[39m getPool()[33m:[
39m [33mPool[39m {
     [90m 109 |[39m   [36mif[39m ([33m![39mpool) {
    [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33
mError[39m([32m'DB_NOT_INITIALIZED'[39m)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 111 |[39m   }
     [90m 112 |[39m   [36mreturn[39m pool[33m;[39m
     [90m 113 |[39m }[0m

      at getPool (src/utils/db.ts:110:11)
      at Object.<anonymous> (src/__tests__/integration/chat.integration.test.ts
:35:25)

FAIL src/__tests__/integration/databaseMigration.integration.test.ts
  ● Database Migration Integration Tests › Schema Initialization › should creat
e all required tables on initialization

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Schema Initialization › should creat
e all required indexes

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Schema Initialization › should have 
correct table schemas

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Data Types and Constraints › should 
enforce UUID primary keys

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Data Types and Constraints › should 
enforce foreign key constraints

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Data Types and Constraints › should 
handle JSONB data type correctly

    read ECONNRESET

    [0m [90m 52 |[39m
     [90m 53 |[39m       [90m// 测试连接[39m
    [31m[1m>[22m[39m[90m 54 |[39m       [36mconst[39m client [33m=[39
m [36mawait[39m [36mthis[39m[33m.[39mtestPool[33m.[39mconnect()[33m;[
39m
     [90m    |[39m                      [31m[1m^[22m[39m
     [90m 55 |[39m       [36mawait[39m client[33m.[39mquery([32m'SELECT 
NOW()'[39m)[33m;[39m
     [90m 56 |[39m       client[33m.[39mrelease()[33m;[39m
     [90m 57 |[39m[0m

      at ../node_modules/.pnpm/pg-pool@3.10.1_pg@8.16.3/node_modules/pg-pool/in
dex.js:45:11
      at async DatabaseTestEnvironment.initialize (src/__tests__/utils/dbTestUt
ils.ts:54:22)
      at async Object.beforeAll (src/__tests__/utils/dbTestUtils.ts:431:5)
      at async Object.<anonymous> (src/__tests__/integration/databaseMigration.
integration.test.ts:11:5)

  ● Database Migration Integration Tests › Data Types and Constraints › should 
handle timestamp columns correctly

    read ECONNRESET
