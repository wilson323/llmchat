#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 运行质量门禁检查..."

# 1. TypeScript类型检查
echo "📝 TypeScript类型检查..."
if ! pnpm run type-check; then
  echo "❌ TypeScript类型检查失败"
  exit 1
fi
echo "✅ TypeScript类型检查通过"

# 2. 代码质量检查
echo "🔧 ESLint代码质量检查..."
if ! pnpm run lint; then
  echo "❌ ESLint代码质量检查失败"
  exit 1
fi
echo "✅ ESLint代码质量检查通过"

# 3. 测试运行
echo "🧪 运行测试套件..."
if ! pnpm run test -- --passWithNoTests; then
  echo "❌ 测试运行失败"
  exit 1
fi
echo "✅ 测试套件通过"

# 4. 构建验证
echo "🏗️ 构建验证..."
if ! pnpm run build; then
  echo "❌ 构建失败"
  exit 1
fi
echo "✅ 构建验证通过"

# 5. 安全检查
echo "🛡️ 依赖安全检查..."
if ! pnpm audit --audit-level moderate; then
  echo "❌ 依赖安全检查失败"
  echo "💡 请运行 'pnpm audit fix' 修复安全问题"
  exit 1
fi
echo "✅ 安全检查通过"

echo "🎉 所有质量门禁检查通过！提交成功。"